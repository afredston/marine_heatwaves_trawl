---
title: "prep_trawl_data"
author: "Alexa Fredston-Hermann"
date: "10/20/2020"
output: html_document
---

IT IS VERY IMPORTANT TO CHECK THAT THERE ARE NO WINTER SURVEYS, AND IF THERE ARE, REVISE THE WAY THE START MONTH IS ESTIMATED. SURVEYS THAT STRADDLE THE NEW YEAR WOULD END UP WITH THE WRONG "START MONTH" FROM EG min(12, 1, 2). 

need to think more about gomx, the months run from 1 to 12, but it's a summer and fall survey...

```{r packages, eval=TRUE, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
library(tidyverse)
library(here)
```

# Pull in North American trawl data from OceanAdapt 

This is too large to keep on GitHub, but can be downloaded from Zenodo here (updated 2020): https://zenodo.org/record/3885625 

```{r OA, eval=TRUE, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
OApath <- "~/github/pinskylab-OceanAdapt-c913be5" # specify where this directory is stored on your machine 
dat_exploded <- readRDS(paste0(OApath, "/data_clean/dat_exploded.rds")) # pull in the entire dataset with zeros representing true absences; think this is based on the list of common species in all-regions-trimmed 

namer_survey_months <- read_csv(here("processed-data","compiled_haul_data.csv")) %>% 
  mutate(month = lubridate::month(datetime)) %>% # suggest checking that there are no december entries here, and if there are, ensure that they're fall surveys not winter, so they don't represent start months! for NAmer this is the case for GoMx and NEUS
  group_by(region) %>% 
  summarise(startmonth=min(month)) %>% 
  mutate(region = str_replace_all(region, c(' Summer'="",' Fall'="",' Winter'="",' Spring'="",' Triennial'="", ' Annual'=""))) %>% 
  group_by(region) %>% 
  summarise(startmonth=min(startmonth))

# calculate true abundance by species and year 
namer_abund <- dat_exploded %>% 
  filter(!wtcpue==Inf) %>% # 19 values from the Southeast US Summer survey in 1992 have values of Inf for some reason
  mutate(region = str_replace_all(region, c(' Summer'="",' Fall'="",' Winter'="",' Spring'="",' Triennial'="", ' Annual'=""))) %>% # get rid of seasons so that the different seasonal surveys in each region look like replicates of one regional survey
  group_by(region, spp, year, stratum, stratumarea) %>% 
  summarise(stratum_mean = mean(wtcpue)*stratumarea) %>% # get average wtcpue for this species*region*year in each stratum, and multiply by size of stratum; collapses df down to one row per species*year*region*stratum 
  group_by(region, spp, year) %>% 
  summarise(sumwt = sum(stratum_mean)) %>% # add up stratum weights 
  left_join(namer_survey_months)

```

# Pull in Europe data

This was prepared by Aurore Maureaud and downloaded from here: https://github.com/AquaAuma/CleanTrawlNAmEUr/blob/main/data/SurveyCPUEs26102020.RData

```{r europe, eval=TRUE, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
load(here("processed-data","SurveyCPUEs26102020.Rdata"))
```

# Write out processed biomass data

Europe to be added when we get the weights data 

```{r write out, eval=TRUE, echo=FALSE, results=FALSE, message=FALSE, warning=FALSE}
write_csv(namer_abund, here("processed-data","biomass_time_namer.csv"))
```
