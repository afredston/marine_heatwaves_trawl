---
title: "prep_trawl_data"
author: "Alexa Fredston-Hermann"
date: "10/20/2020"
output: html_document
---

IT IS VERY IMPORTANT TO CHECK THAT THERE ARE NO WINTER SURVEYS, AND IF THERE ARE, REVISE THE WAY THE START MONTH IS ESTIMATED. SURVEYS THAT STRADDLE THE NEW YEAR WOULD END UP WITH THE WRONG "START MONTH" FROM EG min(12, 1, 2). 

need to think more about gomx, the months run from 1 to 12, but it's a summer and fall survey...

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE, results=FALSE, eval=TRUE)
```

```{r packages}
library(tidyverse)
library(here)
```

# Pull in data 

Currently using:
* North American data from OceanAdapt
* Norway from FISHGLOB

OA is too large to keep on GitHub, but can be downloaded from Zenodo here (updated 2020): https://zenodo.org/record/3885625 

Norway was prepared by Aurore Maureaud and downloaded from here: https://drive.google.com/drive/u/0/folders/1CGY8oI6DbpdHYAMV_8ztetxSrhUPpu3F 

```{r raw data}
# North America
OApath <- "~/github/pinskylab-OceanAdapt-c913be5" # specify where this directory is stored on your machine 
namer_raw_zeros <- readRDS(paste0(OApath, "/data_clean/dat_exploded.rds")) # pull in the entire dataset with zeros representing true absences; think this is based on the list of common species in all-regions-trimmed 

# pull in Norway
nor_raw <- read_csv(here("raw-data","NOR-BTS_clean_May2021.csv"))%>% 
  select(where(~!all(is.na(.x)))) #drop FISHGLOB columns that are all NAs for this survey

nor_haul_info <- nor_raw %>% 
  select("survey", "haul_id", "country", "continent", "year", "month", 
"quarter", "latitude", "longitude", "haul_dur", "area_swept", 
"gear", "depth") %>% 
  distinct() # get all non-species-level information

nor_raw_zeros <- nor_raw %>% 
  expand(haul_id, accepted_name) %>% 
  left_join(nor_haul_info) %>% # populate all the haul-level columns 
  left_join(nor_raw) %>% # add species data back in
  mutate(wgt_cpue = replace_na(wgt_cpue, 0)) %>% # convert NAs to 0s (true absences)
  filter(year >= 2004, # as per Laurene Pecuchet, filtering to only include the Barents Sea autumn survey in years with a standardized survey methodology
         latitude >= 70,
         month %in% c(8,9,10)
  ) # this goes from ~6,100,000 records to just 200,000 ... is there a way to use the rest of the data? (or maybe they're artefacts of the expansion -- e.g., species that are only in the Norwegian Sea?)
```

```{r tidy data}
# get start months for each survey 
namer_survey_months <- read_csv(here("processed-data","compiled_haul_data.csv")) %>% 
  mutate(month = lubridate::month(datetime)) %>% # suggest checking that there are no december entries here, and if there are, ensure that they're fall surveys not winter, so they don't represent start months! for NAmer this is the case for GoMx and NEUS
  group_by(region) %>% 
  summarise(startmonth=min(month)) %>% 
  mutate(region = str_replace_all(region, c(' Summer'="",' Fall'="",' Winter'="",' Spring'="",' Triennial'="", ' Annual'=""))) %>% 
  group_by(region) %>% 
  summarise(startmonth=min(startmonth))

norway_survey_month <- min(nor_raw$month)

# make tidy dataframe 
namer_cpue <- namer_raw_zeros %>% 
  filter(!wtcpue==Inf) %>% # 19 values from the Southeast US Summer survey in 1992 have values of Inf for some reason
  mutate(region = str_replace_all(region, c(' Summer'="",' Fall'="",' Winter'="",' Spring'="",' Triennial'="", ' Annual'=""))) %>% # get rid of seasons so that the different seasonal surveys in each region look like replicates of one regional survey
  group_by(region, spp, year) %>% 
  summarise(wtcpue_mean = mean(wtcpue)) %>% # get mean species-level cpue for that region and year across all hauls in the region
  left_join(namer_survey_months)

nor_cpue <- nor_raw_zeros %>% 
  mutate(spp=accepted_name, region=survey) %>% 
  group_by(region, spp, year) %>% 
  summarise(wtcpue_mean = mean(wgt_cpue))
nor_cpue$startmonth  <- norway_survey_month
```

# Write out processed biomass data

```{r write out}
write_csv(namer_cpue, here("processed-data","biomass_time_namer.csv"))
write_csv(nor_cpue, here("processed-data","biomass_time_norway.csv"))

```
