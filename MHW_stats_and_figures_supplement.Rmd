---
title: "Supplementary Information"
author: "Fredston et al."
date: 2022
output: 
  bookdown::pdf_document2: default
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/nature.csl
---

```{r setup, echo=FALSE, results="hide",message=FALSE, warning=FALSE, include=FALSE}

# load packages
library(tidyverse)
library(here)
library(lubridate) # for standardizing date format of MHW data
library(sf)
library(rnaturalearth)
#library(kableExtra)
library(modelsummary)
library(ggpubr)
library(broom)
library(mcp)
library(lme4)
library(mgcv)
select <- dplyr::select

# marine heatwave data for joining with survey data
mhw_summary_sat_sst_any <- read_csv(here("processed-data","mhw_satellite_sst.csv")) # MHW summary stats from satellite SST record, using any anomaly as a MHW
mhw_summary_sat_sst_5_day <- read_csv(here("processed-data","mhw_satellite_sst_5_day_threshold.csv")) # MHW summary stats from satellite SST record, defining MHWs as events >=5 days
mhw_summary_soda_sst <-  read_csv(here("processed-data","mhw_soda_sst.csv")) # modeled SST from SODA
mhw_summary_soda_sbt <-  read_csv(here("processed-data","mhw_soda_sbt.csv")) # modeled SBT from SODA

# calendar year MHW data for plotting
# mhw_cal_yr_sat_sst_5_day <- read_csv(here("processed-data","MHW_calendar_year_satellite_sst_5_day_threshold.csv"))
# mhw_cal_yr_soda_sst <- read_csv(here("processed-data","MHW_calendar_year_soda_sst.csv"))
# mhw_cal_yr_soda_sbt <- read_csv(here("processed-data","MHW_calendar_year_soda_sbt.csv"))

# survey data 
survey_summary <-read_csv(here("processed-data","survey_biomass_with_CTI.csv"))
survey_spp_summary <- read_csv(here("processed-data","species_biomass_with_CTI.csv")) %>% 
  rename('spp'=accepted_name) %>% 
  mutate(wt_mt_log = as.numeric(wt_mt_log)) 
survey_start_times <- read_csv(here("processed-data","survey_start_times.csv"))
coords_dat <- read_csv(here("processed-data","survey_coordinates.csv"))
haul_info <- read_csv(here("processed-data","haul_info.csv"))
#biomass_time <- read_csv(here("processed-data","biomass_time.csv"))
#footprint <- read_csv(here("processed-data","spatial_standardization_summary.csv"))
med_lat <- haul_info %>% group_by(survey) %>% summarise(med_lat = median(latitude))
survey_names <- read_csv(here("processed-data","survey_names.csv"))
# traits data
traits <- read_csv(here("raw-data","TraitCollectionFishNAtlanticNEPacificContShelf.csv")) %>% 
  select(taxon, tl, feeding.mode, habitat) %>% 
  distinct() %>% 
  group_by(taxon, feeding.mode, habitat) %>% 
  summarise(tl = mean(tl)) %>% 
  group_by(taxon) %>% 
  mutate(n=n()) 

tl <- survey_spp_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day) %>% 
  inner_join(traits %>% select(taxon, tl) %>% distinct(), by=c('spp'='taxon')) %>% 
  mutate(tl_cat = ifelse(tl>4, "4-5", ifelse(tl>3, "3-4","2-3")))

feed <- survey_spp_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day) %>% 
  inner_join(traits %>% select(taxon, feeding.mode, n) %>% distinct() %>% filter(!is.na(feeding.mode)) %>% group_by(taxon) %>% mutate(n=n()) %>% filter(n==1), # get a list of taxa with exactly one feeding mode record 
             by=c('spp'='taxon')) 

hab <- survey_spp_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day) %>% 
  inner_join(traits %>% select(taxon, habitat, n) %>% distinct() %>% filter(!is.na(habitat)) %>% group_by(taxon) %>% mutate(n=n()) %>% filter(n==1), # get a list of taxa with exactly one feeding mode record 
             by=c('spp'='taxon')) 

modeldat <- survey_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
  filter(!is.na(wt_mt_log), !is.na(anom_days)) %>% 
  left_join(med_lat) %>% 
  mutate(
    wt_mt_log_scale = as.numeric(scale(wt_mt_log, center=TRUE, scale=TRUE)),
    cti_log_scale =  as.numeric(scale(cti_log, center=TRUE, scale=TRUE)),
    anom_days_scale =  as.numeric(scale(anom_days, center=TRUE, scale=TRUE)),
    med_lat_scale =  as.numeric(scale(med_lat, center=TRUE, scale=TRUE)),
    depth_wt_scale =  as.numeric(scale(depth_wt, center=TRUE, scale=TRUE))
  )

# lagged effects of MHW duration on biomass 
lags <- modeldat %>%
  group_by(survey) %>% 
  arrange(year) %>% 
  mutate(lag1 = lag(anom_days_scale, 1),
         lag2 = lag(anom_days_scale, 2),
         lag3 = lag(anom_days_scale, 3),
         lag4 = lag(anom_days_scale, 4)) %>% 
  ungroup() %>% 
  select(wt_mt_log_scale, anom_days_scale, lag1, lag2, lag3, lag4)

# make colorblind friendly palettes for plots of single species 
# http://mkweb.bcgsc.ca/colorblind/palettes.mhtml#page-container

cbpal6 <- c('#2271B2','#3DB7E9','#F748A5','#359B73','#D55E00',"black")
# cbpal12 <- c("#9F0162","#009F81","#FF5AAF","#00FCCF","#8400CD","#008DF9","gray50","#00C2F9","#FFB2FD","#A40122","#E20134","#FFC33B") 

# cbpal16 <- c('#68023F','#008169','#EF0096','#00DCB5','#FFCFE2','#003C86','#9400E6','#009FFA','#FF71FD','grey50','#7CFFFA','#6A0213','#008607','#F60239','#00E307','#FFDC3D')

```

```{r, setup2, include=FALSE}
knitr::opts_chunk$set(
  message=FALSE, echo=FALSE, warning=FALSE
)
```

# Supplementary methods

All code used to conduct this analysis is publicly available at
<https://github.com/afredston/marine_heatwaves_trawl>. Raw datasets are
publicly available at [DOI LINK].

## Trawl data preparation

To compare biomass across surveys with different methods, it must be
converted into an index of catch per unit effort (CPUE; here, kg /
km^2^). To estimate the fish biomass from each sample, the minimum
required information is: taxa specific weight or abundance at length
data, swept area or information to estimate it from sampling duration,
sampled distance and gear opening. When species weight needed to be
estimated from abundance at length data for ICES surveys, length-weight
relationships were retrieved from locally relevant areas from
[FishBase](https://www.fishbase.se/). Missing swept area information was
estimated when relevant based on survey variables such as sampling ship,
sampling depth, and haul duration. Reported taxonomy in the surveys was
cleaned and homogenized with the [World Register of Marine
Species](http://www.marinespecies.org) for a semi-automated method, and
information from taxonomic inconsistencies reported by surveys providers
and experts was used to correct taxonomic names. We omitted survey-years
with very few samples, a change in the area sampled, or other
methodological inconsistencies, and only analyzed surveys that were
conducted annually or biennially for at least ten consecutive
survey-years (methods detailed below). A total of 18 surveys were
incorporated, with a total of 202,819 hauls covering 2088 taxa before
spatio-temporal standardization of each survey region. 80% of those taxa
were identified to species, 12% to genus, and the remaining 8% to higher
taxonomic levels. We used all of the taxa for biomass analyses but only
the species-level records for community analyses.

Data cleaning scripts from the [FISHGLOB
project](https://www.fondationbiodiversite.fr/en/the-frb-in-action/programs-and-projects/le-cesab/fishglob/)
are summarized below and contained in [CODE LINK]:

The marine heatwave analysis began with the harmonized FISHGLOB v1.1
public dataset, and additional data trimming measures are summarized
below and contained in
[prep_trawl_data.R](https://github.com/afredston/marine_heatwaves_trawl/blob/main/prep_trawl_data.R):

-   Omit surveys in FISHGLOBv1.1 that show very inconsistent sampling
    patterns in the summary PDFs [PDF LINK]

-   Calculate CPUE for the one region for which it is not calculated in
    FISHGLOB already: the Northeast US. This region does not report
    swept area, but staff at the survey agency (NOAA) use a fixed value
    for the swept area for all hauls, regardless of haul duration (the
    fixed value is standardized to a 30-minute haul). To make this a
    more reasonable assumption, we omit hauls that were shorter than 25
    minutes or longer than 35 minutes, and then calculate CPUE

-   Manually trim out years for which, based on the summary PDFs, our
    expert opinion is that survey methods were not consistent (e.g., far
    fewer hauls than usual). This step most frequently omits the early
    years of a survey, when methods and sampling intensity were not yet
    standardized; these years may also be too early to match to
    temperature data, and thus would have been omitted later in the
    analysis anyway

-   Remove surveys that have fewer than 10 years of data, as our focus
    is temporal dynamics. This step removes three small surveys in
    Canada

-   Trim each survey to one season, i.e., the most consistently or
    frequently sampled three-month interval

-   Standardize spatial footprints over time for each survey by creating
    hexagonal cells covering the Earth's surface, pairing each haul with
    a cell, and retaining only hauls in the cells that were sampled
    every year. Cells were created using the dggridR
    package[@barnes2020a]. We used a cell resolution of 8, corresponding
    to a cell area of 7,774 km^2^, for all regions except the Norway
    survey. Norway conducts an extremely large-scale scientific trawl
    survey that has operated in the Norwegian and Barents Seas for
    decades. Because this survey is larger-scale than all of the others,
    we used a cell resolution of 7 ( cell area of 23,323 km^2^) to
    standardize the footprint of this survey

-   Impute zeros for true absences in every instance where a species
    ever observed in a survey was *not* encountered in a given haul

-   Calculate species-specific mean CPUE as the mean of every CPUE for
    that species in a given survey and year (i.e., average over hauls)

-   Calculate species-specific mean depth as the mean of depths where
    hauls occurred in a given survey and year, weighted by the species'
    CPUE in each haul

## Power analysis

We simulated data to assess whether our study had sufficient power to
detect MHW-driven biomass changes. We fitted an autoregressive linear
model of log biomass over time (Gompertz model) to each region's biomass
data, including MHW presence/absence as a predictor. We extracted the
slope $\beta$, intercept $\alpha$, and conditional standard deviation
$\sigma$ of this model, and used them to simulate data from the same
Gompertz model

$$
log(B_t) = \alpha + \beta \times log( B_{t-1} ) + \gamma \times MHW_t + \sigma'
$$

where $B$ represents biomass, $MHW$ is a binary variable for MHW
presence/absence, and $\gamma$ represents the "true" MHW effect that we
vary to explore power. This simulation also includes an error term
$\sigma'$ calculated as a random draw from a normal distribution with
mean 0 and standard deviation $\sigma$. We (1) varied the number of
years the simulation needed to be run to detect a fixed MHW effect
$\gamma$ and (2) calculated the MHW effect size that could be detected
given the actual number of years of data we have. For both of these
calculations, simulations were run for each region individually,
converted into log ratio units (used in the main text), and pooled
across regions.

## Additional predictors

In addition to the geographical shifts that may lead to changes in
biomass and community composition in a fixed area, marine fishes may
shift deeper in response to warming@chaikin2022 @dulvy2008. We tested
for this by calculating depth log ratios that describe whether
assemblages have gotten deeper or shallower from one survey to the next.
Depth log ratio was quantified by: 1. Taking an average of depths at
which a species was found in each survey and year, using the depth
records for each haul, and weighted by biomass in the haul. 2. Taking a
weighted mean of all these species-level depth values for the entire
survey, again weighted by species biomass. 3. Calculating the log ratio
of these survey-level, biomass-weighted depth values from one year to
the next. We find no relationship between MHW duration and depth log
ratio (Fig. \@ref(fig:fig-depth-point)) and no difference between depth
changes that do and do not follow a MHW (Fig.
\@ref(fig:fig-depth-hist)).

Marine communities across latitudes have responded differently to
climate change, with some declines in species richness recorded in the
tropics and at equatorward range edges@chaudhary2021 @hastings2020 and
some increases in species richness recorded in colder oceans and at
poleward range edges@hastings2020 @english. We also tested for
latitudinal trends in biomass log ratios, finding that the direction or
magnitude of biomass change was not related to the latitude of the
region \@ref(fig:fig-lat-point).

Species frequently exhibit individualistic responses to global
change@fredston2021. We explored whether species taxonomy, species
traits, and regional identity help to predict species-level biomass
change at all and in the context of marine heatwaves. All fish species
traits were obtained from the database in@beukhof2019. Of the
`r length(unique(survey_spp_summary$spp))` taxa used in the analysis,
`r length(unique(tl$spp))` had trophic level data (used in Fig.
\@ref(fig:fig-spp-tl)), `r length(unique(feed$spp))` had feeding mode
data (used in Fig. \@ref(fig:fig-spp-feed)), and
`r length(unique(hab$spp))` had feeding mode data (used in Fig.
\@ref(fig:fig-spp-hab)). The pattern of no relationship between MHW
duration and biomass log ratio persists when data are grouped by trophic
level (Fig. \@ref(fig:fig-spp-tl)), feeding mode (Fig.
\@ref(fig:fig-spp-feed)), or habitat (Fig. \@ref(fig:fig-spp-hab)).

# Supplementary tables

```{r tab-models-wt, caption="Models of biomass change. All models were fitted to scaled and centered biomass log ratio values using MHW duration in days (scaled and centered). Model names correspond to: linear model, linear mixed-effects model with survey identity as a random effect, generalized additive model (GAM), and GAM with survey as a random effect."}
options(modelsummary_get="easystats")

# models of biomass and MHWs to compare 

# LM of MHW duration on biomass
# wt_lm <- lm(wt_mt_log_scale ~ anom_days_scale, data = modeldat)

# LMEM of MHW duration on biomass
# wt_lme <- lmer(wt_mt_log_scale ~ anom_days_scale + 1|survey, data = modeldat)

# GAM of MHW duration on biomass
# wt_gam <- gam(wt_mt_log_scale ~ s(anom_days_scale), data = modeldat )

# GAM of MHW duration on biomass with a random effect
# wt_gam_re <- gam(wt_mt_log_scale ~ s(anom_days_scale) + s(survey, bs="re"), data = modeldat  %>% mutate(survey = as.factor(survey)))

mlag0 <- function(dat){
  gam( wt_mt_log_scale ~ s(as.matrix(dat)[,2:2]), data=dat ) # regular GAM
}
mlag1 <- function(dat){
  gam( wt_mt_log_scale ~ s(as.matrix(dat)[,2:3]), data=dat )
}
mlag2 <- function(dat){
  gam( wt_mt_log_scale ~ s(as.matrix(dat)[,2:4]), data=dat )
}
mlag3 <- function(dat){
  gam( wt_mt_log_scale ~ s(as.matrix(dat)[,2:5]), data=dat )
}
mlag4 <- function(dat){
  gam( wt_mt_log_scale ~ s(as.matrix(dat)[,2:6]), data=dat )
}
#wt_gam_lag1 = mlag1(lags)
#wt_gam_lag2 = mlag2(lags)
#wt_gam_lag3 = mlag3(lags)
#wt_gam_lag4 = mlag4(lags)

# breakpoint regression 
# model = list(
#   wt_mt_log_scale ~ 1 + anom_days_scale,
#   ~ 0 +anom_days_scale
# )
# wt_bp = mcp(model, data=modeldat)

# compare all biomass models 
#AIC(wt_lm, wt_lme, wt_gam, wt_gam_re, wt_gam_lag1, wt_gam_lag2, wt_gam_lag3, wt_gam_lag4)

models <- list(
  "LM" = lm(wt_mt_log_scale ~ anom_days_scale, data = modeldat),
  "LME" = lmer(wt_mt_log_scale ~ anom_days_scale + 1|survey, data = modeldat),
  "GAM" = gam(wt_mt_log_scale ~ s(anom_days_scale), data = modeldat ), 
  "GAM + RE" = gam(wt_mt_log_scale ~ s(anom_days_scale) + s(survey, bs="re"), data = modeldat  %>% mutate(survey = as.factor(survey))) ,
  # "Breakpoint Regression" = mcp(list(
  # wt_mt_log_scale ~ 1 + anom_days_scale,
  # ~ 0 +anom_days_scale), data=modeldat),
  "GAM Lag 1" = mlag1(lags), 
  "GAM Lag 2" = mlag2(lags), 
  "GAM Lag 3" = mlag3(lags), 
  "GAM Lag 4" = mlag4(lags)
)

modelsummary(models[1:4], metrics=c("Num.Obs.","R2","AIC","estimate","p.value")) 
```


```{r tab-models-wt2, caption="Models of biomass change. All models were fitted to scaled and centered biomass log ratio values using MHW duration in days (scaled and centered). Model names correspond to: GAM with a matrix of predictors including MHW data from 2-5 years prior to the survey in addition to the year prior to the survey."}

modelsummary(models[5:8], metrics=c("Num.Obs.","R2","AIC","estimate","p.value")) 

# lagged effects of MHW duration on biomass, by survey 
# wt_gam_lag_surv <- NULL
# for(i in unique(modeldat$survey)){
#   tmp <- modeldat %>% 
#     filter(survey==i) %>% 
#     arrange(year) %>% 
#     mutate(lag1 = lag(anom_days_scale, 1),
#            lag2 = lag(anom_days_scale, 2),
#            lag3 = lag(anom_days_scale, 3)) %>% 
#     ungroup() %>% 
#     select(wt_mt_log_scale, anom_days_scale, lag1, lag2, lag3)
#   
#   # manual stop for regions where GAM throws this error without decreasing df:
#   #  Error in smooth.construct.tp.smooth.spec(object, dk$data, dk$knots) : 
#   # A term has fewer unique covariate combinations than specified maximum degrees of freedom 
#   if(i %in% c('FR-CGFS','GOA','DFO-QCS','WCANN','PT-IBTS','NIGFS')){
#     tmp0 <- cbind(glance(  gam( wt_mt_log_scale ~ s(as.matrix(tmp)[,2:2], k=3), data=tmp )
#     ), 'survey'=i,'model'='mlag0',kreduce = TRUE)    
#     tmp1 <- cbind(glance(  gam( wt_mt_log_scale ~ s(as.matrix(tmp)[,2:3], k=3), data=tmp )
#     ), 'survey'=i,'model'='mlag1',kreduce = TRUE)    
#     tmp2 <- cbind(glance(  gam( wt_mt_log_scale ~ s(as.matrix(tmp)[,2:4], k=3), data=tmp )
#     ), 'survey'=i,'model'='mlag2',kreduce = TRUE)    
#     tmp3 <- cbind(glance(  gam( wt_mt_log_scale ~ s(as.matrix(tmp)[,2:5], k=3), data=tmp )
#     ), 'survey'=i,'model'='mlag3',kreduce = TRUE)
#   } else{
#     
#     tmp0 <- cbind(glance(mlag0(tmp)), 'survey'=i,'model'='mlag0',kreduce = FALSE)
#     tmp1 <- cbind(glance(mlag1(tmp)), 'survey'=i,'model'='mlag1',kreduce = FALSE)
#     tmp2 <- cbind(glance(mlag2(tmp)), 'survey'=i,'model'='mlag2',kreduce = FALSE)
#     tmp3 <- cbind(glance(mlag3(tmp)), 'survey'=i,'model'='mlag3',kreduce = FALSE)
#   }
#   wt_gam_lag_surv <- rbind(wt_gam_lag_surv, tmp0, tmp1, tmp2, tmp3)
# }
# ggplot(wt_gam_lag_surv) +
#   geom_col(aes(x=survey, y=AIC, color=model, group=model, fill=model), position="dodge") +
#   scale_color_brewer(palette=8, type="seq") + 
#   scale_fill_brewer(palette=8, type="seq") +
#   theme_bw()
# write_csv(wt_gam_lag_surv, here('processed-data','lag_gam_summary.csv'))
```

```{r tbl-spp}
spprank <- survey_spp_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
  filter(!is.na(wt_mt)) %>% 
  group_by(survey, spp) %>% 
  summarise(sumwt = sum(wt_mt)) %>% 
  arrange(-sumwt) %>% 
  slice(1:5) %>% 
  select(-sumwt) %>% 
  mutate(flag = "keep",
         counterprep = 1:n(),
         counter = paste0("spp", as.character(counterprep))) %>%  # add a rank for each species 
  ungroup() %>% 
  select(-counterprep)

topspp <- survey_spp_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
  left_join(spprank, by=c('spp','survey')) %>% 
  filter(flag=='keep') %>% 
  select(survey, counter, wt_mt, year) %>% 
  group_by(survey) %>% 
  mutate(wt_mt_scale = scale(wt_mt, scale = TRUE, center = TRUE), .keep="unused") %>% 
  pivot_wider(names_from="counter", values_from="wt_mt_scale") %>% 
  left_join(survey_summary %>% select(year, survey, wt_mt) %>% group_by(survey) %>% mutate(wt_mt_scale = scale(wt_mt, scale = TRUE, center = TRUE), .keep="unused")  %>% ungroup(), by=c("year","survey"))

sppmodels <- list(
  "LME-1" = lmer(wt_mt_scale ~ spp1 + (1|survey), data = topspp),
  "LME-2" = lmer(wt_mt_scale ~ spp1 + spp2 + (1|survey), data = topspp),
  "LME-3" = lmer(wt_mt_scale ~ spp1 + spp2 + spp3 + (1|survey), data = topspp),
  "LME-4" = lmer(wt_mt_scale ~ spp1 + spp2 + spp3 + spp4 + (1|survey), data = topspp),
  "LME-5" = lmer(wt_mt_scale ~ spp1 + spp2 + spp3 + spp4 + spp5 + (1|survey), data = topspp))

modelsummary(sppmodels, metrics=c('Num.Obs','R2','AIC','Log.Lik.','F','RMSE'))
```

```{r tab-models-cti, caption="Models of CTI change. All models were fitted to scaled and centered CTI log ratio values using MHW duration in days (scaled and centered). Model names correspond to: linear model, linear mixed-effects model with survey identity as a random effect, generalized additive model (GAM), GAM with survey as a random effect, and GAM with a matrix of predictors including MHW data from 1-4 years prior to the survey in addition to the year prior to the survey."}
modelsummary(list(
  "LM" = lm(cti_log_scale ~ anom_days_scale, data = modeldat),
  "LME" = lmer(cti_log_scale ~ anom_days_scale + 1|survey, data = modeldat)
))
```

```{r tab-models-depth, caption="Model of depth change. Depth log ratio and MHW duration variables were scaled and centered."}
# LM of MHW duration on depth (MHW-years only)
modelsummary(lm(depth_wt_scale ~ anom_days_scale, data = modeldat))
```

```{r tab-models-lat, caption="Models of biomass change as a function of MHW duration and median survey latitude. All variables were scaled and centered."}
modelsummary(lm(wt_mt_log_scale ~ anom_days_scale + med_lat_scale, data = modeldat)) 
```

```{r tab-lm-spp, fig.cap="C", eval=FALSE}
sppscaled <- survey_spp_summary %>% 
  left_join(mhw_summary_sat_sst_5_day) %>% 
  filter(wt_mt_log > -Inf, wt_mt_log < Inf) %>% 
  mutate(log_scaled = scale(wt_mt_log, scale=TRUE, center=TRUE),
         days_scaled = scale(anom_days, scale=TRUE, center=TRUE)) 
summary(lm(formula = "wt_mt_log ~ survey + anom_days",data=sppscaled))
lmer(formula = wt_mt_log ~ anom_days + (1|survey) + (anom_days|survey),data=sppscaled)

```

# Supplementary figures

```{r fig-mhw-metric, fig.cap="Biomass change (log ratio) and three metrics of measuring MHW impacts: severity (total anomaly in °C), duration (number of days), and cumulative mean intensity (severity divided by duration, i.e., the average anomaly over the course of the MHW)." }
gg_mhw_metric <- survey_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
  pivot_longer(cols=c(anom_days, anom_sev, anom_int), values_to = "value", names_to = "metric") %>% 
  mutate(metric = recode(metric, anom_days='Duration (days)',anom_sev= 'Severity (°C)',anom_int= 'Cumulative mean intensity (°C/day)')) %>% 
  ggplot(aes(x=value, y=wt_mt_log)) +
  geom_point() + 
  geom_smooth(method="lm") +
  facet_wrap(~metric, scales="free_x") +
  stat_regline_equation(aes(label=..rr.label..), label.y=-2) +
  labs(x="MHW metric",y="Biomass log ratio") +
  theme_bw() + 
  NULL
gg_mhw_metric
```

```{r fig-mhw-alt, fig.cap="Biomass change (log ratio) and MHW severity from three data products. Severity is calculated as the total anomaly (°C) over the 12-month interval to which each biomass log ratio is paired. Note that the greater magnitude of severity values in OISST (see x-axis) are due to its higher (daily) temporal resolution revealing greater temperature anomalies than those that appear in the monthly SODA datasets."}
gg_mhw_alt <- mhw_summary_soda_sbt%>% 
  mutate(source = "SODA SBT") %>% 
  select(-anomMonths) %>% 
  bind_rows(mhw_summary_soda_sst %>% mutate(source = "SODA SST") %>% select(-anomMonths)) %>%
  bind_rows(mhw_summary_sat_sst_any %>% mutate(source = "OISST") %>% select(-anom_days)) %>% 
  left_join(survey_summary, by="ref_yr") %>% 
  ggplot(aes(x=anom_sev, y=wt_mt_log)) +
  geom_point() +
  geom_smooth(method="lm") +
  theme_bw() + 
  coord_cartesian(clip = "off") +
  labs(x="MHW severity (total anomaly, °C)", y="Biomass log ratio") +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  facet_wrap(~source, scales="free_x") +
  stat_regline_equation(aes(label=..rr.label..), label.y=-2) +
  NULL
gg_mhw_alt

```

```{r fig-abs-biomass, fig.cap="MHW duration and absolute value of biomass log ratio."}

gg_mhw_biomass_point_abs <- survey_summary %>% 
  inner_join (mhw_summary_sat_sst_5_day, by="ref_yr") %>% # get MHW data matched to surveys
  ggplot(aes(x=anom_days, y=abs(wt_mt_log))) +
  geom_point() +
  theme_bw() + 
  geom_smooth(method="lm", color="blue") +
  #geom_smooth(method="lm", formula = y ~ poly(x, degree=3), color="red", se=FALSE) +
  #  geom_smooth(method="loess", color="green", se=FALSE) +
  #geom_line(data = my.model.abs, aes(x=anom_days, y=wt_mt_log_abs), colour = "yellow", size=1) +
  labs(x="MHW duration (days)", y="Absolute biomass log ratio") +
  stat_regline_equation(aes(label=..rr.label..), label.x=25, label.y=2.25) +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") 
gg_mhw_biomass_point_abs

```

```{r fig-depth-point, fig.cap="Fish assemblage depth change (log ratio) and MHW duration."}
gg_mhw_biomass_point_depth <- survey_summary %>% inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% # get MHW data matched to surveys 
  ggplot(aes(x=anom_days, y=depth_wt_log, fill=wt_mt_log, color=wt_mt_log, group=mhw_yes_no)) + 
  geom_point(position = "jitter") + 
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  coord_cartesian(clip = "off") + 
  labs(x="Marine heatwave duration (days)", y="Depth log ratio", fill="Biomass log ratio",color="Biomass log ratio") + scale_color_viridis_c() + scale_fill_viridis_c() + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  stat_regline_equation(aes(label=..rr.label..))

gg_mhw_biomass_point_depth # lm estimate is 0.3 with SE 0.16, p = 0.0575

```

```{r fig-depth-hist, fig.cap="Fish assemblage depth change (log ratio) and MHW occurrence. "}

gg_mhw_biomass_hist_depth <- survey_summary %>% inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% # get MHW data matched to surveys 
  mutate(mhw_yes_no = recode(mhw_yes_no, no="No MHW", yes="MHW")) %>% 
  ggplot(aes(x=depth_wt_log, group=mhw_yes_no, fill=mhw_yes_no, color=mhw_yes_no)) + geom_freqpoly(binwidth=0.1, alpha=0.8, size=2) + 
  scale_color_manual(values=c("#E31A1C","#1F78B4")) + 
  scale_fill_manual(values=c("#E31A1C","#1F78B4")) + 
  theme_bw() + 
  labs(x="Depth log ratio", y="Frequency") + 
  theme(legend.position = "none", legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

gg_mhw_biomass_hist_depth
```

```{r fig-lat-point, fig.cap="Biomass change (log ratio) and MHW duration, color-coded by median latitude of each survey region."}
med_lat <- haul_info %>% group_by(survey) %>% summarise(med_lat = median(latitude))

gg_mhw_biomass_point_latitude <- survey_summary %>% inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% # get MHW data matched to surveys
  left_join(med_lat)%>% 
  ggplot(aes(x=anom_days, y=wt_mt_log, fill=med_lat, color=med_lat)) +
  geom_point(position = "jitter") + 
  theme_bw() + coord_cartesian(clip = "off") + 
  labs(x="Marine heatwave duration (days)", y="Biomass log ratio", fill='Median latitude', color='Median latitude') + 
  scale_color_viridis_c() + 
  scale_fill_viridis_c() + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black")+
  geom_smooth(method="lm", color="gray35")+
  stat_regline_equation(aes(label=..rr.label..))

gg_mhw_biomass_point_latitude

```

```{r fig-lag-point, fig.cap="Biomass change (log ratio) and MHW duration calculated the preceding year as in the main text (0-12 months), a one-year lag (12-24 months), and a two-year lag (24-36 months)."}

gg_mhw_biomass_point_lags <- survey_summary %>% 
  inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
  filter(!survey %in% c('AI','GOA')) %>% 
  group_by(survey) %>% 
  arrange(year) %>% 
  mutate(anom_days_lag1 = lag(anom_days, n=1), anom_days_lag2 = lag(anom_days, n=2)) %>% select(survey, wt_mt_log, anom_days, anom_days_lag1, anom_days_lag2) %>% pivot_longer(cols=c(anom_days, anom_days_lag1, anom_days_lag2), names_to="lag", values_to="anomaly_days") %>% 
  mutate(lag = recode(lag, anom_days = "0_12",anom_days_lag1= "12_24",anom_days_lag2="24_36")) %>% 
  ggplot(aes(x=anomaly_days, y=wt_mt_log)) + 
  geom_point() + geom_smooth(method="lm") + 
  # geom_smooth(data = lm.dat1, method="lm", formula = wt_mt_log ~ anom_days, inherit.aes = FALSE, aes(x=anom_days, y=wt_mt_log)) + 
  # geom_line(data=lm.predict1, aes(x=anom_days, y=wt_mt_log), color="darkgrey", size=1, inherit.aes = FALSE) +
  theme_bw() + 
  coord_cartesian(clip = "off") + 
  labs(x="Marine heatwave duration (days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  facet_wrap(~lag) 

gg_mhw_biomass_point_lags
```

```{r fig-nhaul-wt, fig.cap="Absolute value of biomass log ratios vs. sampling intensity, defined as the average number of samples (hauls) per year in each region."}
hauldat <- haul_info %>% 
  group_by(survey) %>% 
  summarise(Years = length(unique(year)), Hauls = length(unique(haul_id))) %>% 
  mutate(hyr = Hauls/Years) 

survey_summary %>% 
  mutate(abs_wt_mt_log = abs(wt_mt_log)) %>% 
  filter(!is.na(abs_wt_mt_log)) %>% 
  left_join(hauldat, by="survey") %>% 
  ggplot() + 
  geom_boxplot(aes(x=hyr, y=abs_wt_mt_log, group=survey)) +
  geom_smooth(method="lm", aes(x=hyr, y=abs_wt_mt_log)) +
  stat_regline_equation(aes(x=hyr, y=abs_wt_mt_log, label=..rr.label..)) +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  labs(x="Samples (hauls) per year", y="Absolute value of biomass change (log ratio)")
  theme_bw()
  NULL

```

```{r fig-spp-tl, fig.cap="Biomass log ratio and MHW duration grouped by trophic level of each taxon."}

ggplot(tl %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_days, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~tl_cat) +
  geom_smooth(method="lm") + 
  theme_bw() + 
  labs(x="Marine heatwave duration (days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

```

```{r fig-spp-feed, fig.cap="Biomass log ratio and MHW duration grouped by feeding mode of each taxon."}


ggplot(feed %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_days, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~feeding.mode) +
  geom_smooth(method="lm") + 
  theme_bw() + 
  labs(x="Marine heatwave duration (days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

```

```{r fig-spp-hab, fig.cap="Biomass log ratio and MHW duration grouped by habitat preference of each taxon."}

ggplot(hab %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_days, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~habitat) +
  geom_smooth(method="lm") + 
  theme_bw() + 
  labs(x="Marine heatwave duration (days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

```

```{r fig-spp, fig.keep="all", fig.cap=paste0("Biomass trends and historical MHWs by region. The top five taxa by biomass are highlighted. Shaded grey rectangles denote when any MHWs occurred in the preceding survey-year (e.g., 2015 in the Eastern Bering Sea time-series corresponds to the survey that began in June 2015, and MHW data from June 2014 - May 2015). British Columbia and the Gulf of Alaska are biennial surveys; all others are annual.")}

plot_spp <- function(x){
  topspp <- survey_spp_summary %>% 
    filter(survey == x) %>% 
    group_by(spp, survey) %>% 
    summarise(tot = sum(wt_mt)) %>% 
    ungroup() %>% 
    arrange(-tot) %>% 
    slice(1:5) 
  
  plot_prep <- survey_spp_summary %>% 
    filter(survey == topspp$survey, spp %in% topspp$spp) %>% 
    group_by(year, spp, ref_yr, survey) %>% 
    summarise(wt_mt = sum(wt_mt)) %>% 
    ungroup() %>% 
    bind_rows(survey_spp_summary %>% filter(survey == topspp$survey, !spp %in% topspp$spp) %>% group_by(year, ref_yr, survey) %>% summarise(wt_mt = sum(wt_mt)) %>% mutate(spp="Others")) %>% 
    inner_join(mhw_summary_sat_sst_5_day, by="ref_yr") %>% 
    group_by(survey, year) %>% 
    mutate(tot = sum(wt_mt)) %>% # set up height for MHW rectangle
    group_by(survey) %>% 
    mutate(maxtot = max(tot)) %>% 
    ungroup() %>% 
    mutate(bar1 = ifelse(mhw_yes_no == "yes", maxtot, 0)) %>% 
    left_join(survey_names) %>% 
    mutate(spp = factor(spp, levels=c(topspp$spp, "Others")))
  
 reg_plot <-  ggplot() +
    geom_area(data=plot_prep, aes(x=year, y=wt_mt, color=spp, fill=spp, group=spp)) + 
    geom_col(data=plot_prep %>% select(year, bar1) %>% distinct(), aes(x=year, y=bar1), color="transparent", fill="grey70", alpha=0.5) +
    scale_color_manual(values=cbpal6) +
    scale_fill_manual(values=cbpal6) +
    theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          legend.position="right",
          legend.title = element_blank()) + 
    labs(x="Year",y="Biomass (mt)", title=survey_names[survey_names$survey==x,]$title) +
    NULL
 
 print(reg_plot)
}

spp_plots <- purrr::map(survey_names$survey, ~plot_spp(.x))
```

# References
