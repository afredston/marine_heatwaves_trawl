---
title: "Supplementary Information"
author: "Fredston et al."
date: 2022
output: 
  bookdown::pdf_document2: default
header-includes: 
editor_options: 
  markdown: 
    wrap: 72
bibliography: references.bib
csl: https://raw.githubusercontent.com/citation-style-language/styles/master/nature.csl
---

```{r setup, echo=FALSE, results="hide",message=FALSE, warning=FALSE, include=FALSE}
set.seed(42)
# load packages
library(tidyverse)
library(here)
library(lubridate) # for standardizing date format of MHW data
library(sf)
#library(rnaturalearth)
library(kableExtra)
#library(modelsummary)
library(ggpubr)
library(broom)
#library(mcp)
#library(lme4)
library(mgcv)
library(cowplot)
library(glmmTMB)

select <- dplyr::select

# marine heatwave data 

# glorys and oisst are different data sources 
# "5 day" indicates that MHWs shorter than 5 days were omitted (common threshold) 
# d / nod indicates detrending / no detrending

mhw_summary_oisst_d <- read_csv(here("processed-data","MHW_oisst.csv"))
mhw_summary_glorys_d <- read_csv(here("processed-data","MHW_glorys.csv"))

mhw_summary_oisst_d_5_day <- read_csv(here("processed-data","MHW_oisst_5_day_threshold.csv"))
mhw_summary_glorys_d_5_day <- read_csv(here("processed-data","MHW_glorys_5_day_threshold.csv")) # this is the dataset used in the main analysis 

mhw_summary_oisst_nod <- read_csv(here("processed-data","MHW_oisst_no_detrending.csv"))
mhw_summary_glorys_nod <- read_csv(here("processed-data","MHW_glorys_no_detrending.csv"))

mhw_summary_oisst_nod_5_day <- read_csv(here("processed-data","MHW_oisst_5_day_threshold_no_detrending.csv"))
mhw_summary_glorys_nod_5_day <- read_csv(here("processed-data","MHW_glorys_5_day_threshold_no_detrending.csv"))

mhw_summary_glorys_d_any_summer <- read_csv(here("processed-data","MHW_glorys_summer_only.csv"))


# raw MHW data
oisst_raw_d <- read.delim(here("raw-data","MHW_95P_surveys_satellite_surf.csv"), sep=";") %>% 
  rename("dateRaw"=X) %>% 
  mutate(date = dmy(dateRaw), 
         source="OISST")
glorys_raw_d <- read.delim(here("raw-data","MHW_95P_surveys_glorys_surf.csv"), sep=";") %>% 
  rename("dateRaw"=X) %>% 
  mutate(date = dmy(dateRaw),
         source="GLORYS")

# survey data 
survey_summary <-read_csv(here("processed-data","survey_biomass_with_CTI.csv"))
survey_spp_summary <- read_csv(here("processed-data","species_biomass_with_CTI.csv")) %>% 
  rename('spp'=accepted_name) %>% 
  mutate(wt_mt_log = as.numeric(wt_mt_log)) 
survey_start_times <- read_csv(here("processed-data","survey_start_times.csv"))
coords_dat <- read_csv(here("processed-data","survey_coordinates.csv"))
haul_info <- read_csv(here("processed-data","haul_info.csv"))
#biomass_time <- read_csv(here("processed-data","biomass_time.csv"))
#footprint <- read_csv(here("processed-data","spatial_standardization_summary.csv"))
med_lat <- haul_info %>% group_by(survey) %>% summarise(med_lat = median(latitude))
survey_names <- read_csv(here("processed-data","survey_names.csv"))

# traits data
traits <- read_csv(here("raw-data","TraitCollectionFishNAtlanticNEPacificContShelf.csv")) %>% 
  select(taxon, tl, feeding.mode, habitat) %>% 
  distinct() %>% 
  group_by(taxon, feeding.mode, habitat) %>% 
  summarise(tl = mean(tl)) %>% 
  group_by(taxon) %>% 
  mutate(n=n()) 

# fishing data from Sea Around Us
# see https://dx.doi.org/10.14288/1.0404487
sauprep <- read_csv(here("raw-data","20221110_taxa_for_deng GP.csv")) %>%
  filter(!is.na(B_Bmsy)) %>% # taxa have either both B/Bmsy and F/Fmsy, or neither
  select(survey, accepted_name, F_Fmsy, B_Bmsy)

sau <- survey_spp_summary %>% 
  inner_join(sauprep, by=c("survey","spp"="accepted_name")) %>%
  inner_join(mhw_summary_glorys_d_5_day) %>%
group_by(survey, spp) %>% 
  mutate(
    wt_mt_log_scale = as.numeric(scale(wt_mt_log, center=TRUE, scale=TRUE)),
    anom_sev_scale =  as.numeric(scale(anom_sev, center=TRUE, scale=TRUE)),
    b_bmsy_scale =  as.numeric(scale(B_Bmsy, center=TRUE, scale=TRUE)),
        f_fmsy_scale =  as.numeric(scale(F_Fmsy, center=TRUE, scale=TRUE))
  ) %>%
  ungroup() %>% 
  select(survey, spp, year, wt_mt_log_scale,anom_sev_scale,  b_bmsy_scale,f_fmsy_scale )%>%
  drop_na()

# clean up raw MHW data
rawsourcedat <- bind_rows(oisst_raw_d,glorys_raw_d) %>%
  pivot_longer(cols=baltic_sea:west_coast, names_to="survey", values_to="anom") %>% 
  mutate(survey = gsub('_','-',survey),
         survey = toupper(survey),
         survey = recode(survey, 
                         "BALTIC-SEA" = "BITS",
                         "BRITISH-COLUMBIA" = "DFO-QCS", 
                         "EASTERN-BERING-SEA" = "EBS",
                         "GULF-OF-MEXICO" = "GMEX",
                         "GULF-OF-ALASKA" = "GOA",
                         "NOR-BTS" = "Nor-BTS",
                         "SCOTIAN-SHELF" = "SCS",
                         "SOUTHEAST" = "SEUS",
                         "WEST-COAST" = "WCANN"))%>%
  left_join(survey_names)
 

#dissimilarity data
beta_div <- read_csv(here("processed-data","survey_temporal_beta_diversity.csv")) %>% 
  left_join(survey_start_times) %>% # add in the ref_yr column 
  select(-month_year, -survey_date) %>% 
  left_join(mhw_summary_glorys_d_5_day) # add in mhw data

tl <- survey_spp_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day) %>% 
  inner_join(traits %>% select(taxon, tl) %>% distinct(), by=c('spp'='taxon')) %>% 
  mutate(tl_cat = ifelse(tl>4, "4-5", ifelse(tl>3, "3-4","2-3")))

feed <- survey_spp_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day) %>% 
  inner_join(traits %>% select(taxon, feeding.mode, n) %>% distinct() %>% filter(!is.na(feeding.mode)) %>% group_by(taxon) %>% mutate(n=n()) %>% filter(n==1), # get a list of taxa with exactly one feeding mode record 
             by=c('spp'='taxon')) 

hab <- survey_spp_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day) %>% 
  inner_join(traits %>% select(taxon, habitat, n) %>% distinct() %>% filter(!is.na(habitat)) %>% group_by(taxon) %>% mutate(n=n()) %>% filter(n==1), # get a list of taxa with exactly one feeding mode record 
             by=c('spp'='taxon')) 

modeldat <- survey_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
  filter(!is.na(wt_mt_log), !is.na(anom_sev)) %>% 
  left_join(med_lat) %>% 
  mutate(med_lat_scale =  as.numeric(scale(med_lat, center=TRUE, scale=TRUE))) %>% # doesn't need to be centered and scaled within surveys first, since there's only one lat value per survey 
  group_by(survey) %>% 
  mutate(
    wt_mt_scale = as.numeric(scale(wt_mt, center=TRUE, scale=TRUE)),
    wt_mt_log_scale = as.numeric(scale(wt_mt_log, center=TRUE, scale=TRUE)),
    cti_diff_scale =  as.numeric(scale(cti_diff, center=TRUE, scale=TRUE)),
    anom_sev_scale =  as.numeric(scale(anom_sev, center=TRUE, scale=TRUE)),
    depth_wt_scale =  as.numeric(scale(depth_wt, center=TRUE, scale=TRUE))
  ) %>% 
  arrange(year) %>% 
  mutate(
    wt_mt_lag = log(lag(wt_mt))) %>% 
  ungroup() %>% 
  mutate( # alternative scaling method--among, not within, regions
    anom_sev_scale_alt =  as.numeric(scale(anom_sev, center=TRUE, scale=TRUE))
  ) 

# lagged effects of MHW severity on biomass, for GAMs
lags <- modeldat %>%
  group_by(survey) %>% 
  arrange(year) %>% 
  mutate(lag1 = lag(anom_sev_scale, 1),
         lag2 = lag(anom_sev_scale, 2),
         lag3 = lag(anom_sev_scale, 3),
         lag4 = lag(anom_sev_scale, 4)) %>% 
  ungroup() %>% 
  select(wt_mt_log_scale, anom_sev_scale, lag1, lag2, lag3, lag4)

# make colorblind friendly palettes for plots of single species 
# http://mkweb.bcgsc.ca/colorblind/palettes.mhtml#page-container

cbpal6 <- c('#2271B2','#3DB7E9','#F748A5','#359B73','#D55E00',"black")
# cbpal12 <- c("#9F0162","#009F81","#FF5AAF","#00FCCF","#8400CD","#008DF9","gray50","#00C2F9","#FFB2FD","#A40122","#E20134","#FFC33B") 

# cbpal16 <- c('#68023F','#008169','#EF0096','#00DCB5','#FFCFE2','#003C86','#9400E6','#009FFA','#FF71FD','grey50','#7CFFFA','#6A0213','#008607','#F60239','#00E307','#FFDC3D')

# for power analysis
sim_test_summ_gamma_oisst <- readRDS(here("processed-data","sim_test_summ_gamma_oisst.rds"))
sim_test_summ_yrs_oisst <- readRDS(here("processed-data","sim_test_summ_yrs_oisst.rds"))
colnames(sim_test_summ_gamma_oisst) <- c('exp_gamma','propsig')
colnames(sim_test_summ_yrs_oisst) <- c('n_years','propsig','n_years_tot')

sim_test_summ_gamma_glorys <- readRDS(here("processed-data","sim_test_summ_gamma_glorys.rds"))
sim_test_summ_yrs_glorys <- readRDS(here("processed-data","sim_test_summ_yrs_glorys.rds"))
colnames(sim_test_summ_gamma_glorys) <- c('exp_gamma','propsig')
colnames(sim_test_summ_yrs_glorys) <- c('n_years','propsig','n_years_tot')
```

```{r opts, setup2, include=FALSE}
knitr::opts_chunk$set(
  message=FALSE, echo=FALSE, warning=FALSE
)
```

# Software

Code and data for this analysis can be found on GitHub at
<https://github.com/afredston/marine_heatwaves_trawl>. The statistical
analysis used the following packages: glmmTMB[@brooks2017] to fit
generalized linear models, mgcv[@wood2006] to fit generalized additive
models, dggridR[@barnes2020] for spatial standardization of data, and
ncdf4[@pierce2019] for processing marine heatwave data.

# Supplementary tables

```{r tbl-surveys}
kbl(survey_names, booktabs=TRUE, col.names=c("Code","Survey"), caption="Survey names used in this analysis, and corresponding codes used in figures and tables in this Supplement.") %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```

\clearpage

```{r tbl-models-mhws}
null.wt <- lm(wt_mt_log_scale ~ 1, data=modeldat)
lm.wt <- lm(wt_mt_log_scale ~ anom_sev_scale, data = modeldat)
lm.fixed.wt <- lm(wt_mt_log_scale ~ anom_sev_scale + factor(survey), data = modeldat)
gam.wt <- gam(wt_mt_log_scale ~ s(anom_sev_scale), data = modeldat )
gam.re.wt <- gam(wt_mt_log_scale ~ s(anom_sev_scale) + s(survey, bs="re"), data = modeldat  %>% mutate(survey = as.factor(survey)))

# all of the ugly code below pulls out the correct table values from the models and formats them nicely so they don't have too many digits printed 
int.wt <- c(
  paste0(format(round(coef(summary(null.wt))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.wt))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.wt))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.wt))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.wt))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.wt))[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.wt)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.wt)$p.table[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.re.wt)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.re.wt)$p.table[1,2], digits=3), nsmall=2))
)
coef.wt <- c(
  "NA",
  paste0(format(round(coef(summary(lm.wt))[2,1], digits=3), nsmall=2)," ± ",
         format(round(coef(summary(lm.wt))[2,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.wt))[2,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.wt))[2,2]), digits=3), nsmall=2),
  "NA",
  "NA"
)
p.wt <- c(
  "NA",
  format(round(coef(summary(lm.wt))[2,4], digits=3), nsmall=2),
  format(round(coef(summary(lm.fixed.wt))[2,4], digits=3), nsmall=2),
  format(round(summary(gam.wt)$s.pv, digits=3), nsmall=2),
  format(round(summary(gam.re.wt)$s.pv[1], digits=3), nsmall=2)
)

r2.wt <- c("NA",
           format(round(c(
             summary(lm.wt)$r.squared, 
             summary(lm.fixed.wt)$r.squared,
             summary(gam.wt)$r.sq, 
             summary(gam.re.wt)$r.sq
           ), digits=3), nsmall=2))
aic.wt <- round(c(
  AIC(null.wt),
  AIC(lm.wt),
  AIC(lm.fixed.wt),
  AIC(gam.wt),
  AIC(gam.re.wt)
))
df.wt <- round(c(
  summary(null.wt)$df[2], 
  summary(lm.wt)$df[2], 
  summary(lm.fixed.wt)$df[2],
  gam.wt$df.residual, 
  gam.re.wt$df.residual
))


colnames.wt <- c('Null','LM','LM Survey','GAM','GAM Survey')
rownames.wt <- c('Intercept', 'MHW coefficient',"Coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

wt.tbl <- data.frame(rbind(int.wt, coef.wt, p.wt, r2.wt, aic.wt, df.wt), row.names=rownames.wt) 
colnames(wt.tbl) <- colnames.wt

# ±
kbl(wt.tbl, booktabs = TRUE, caption = "Models of biomass response to MHWs. All models were fitted to biomass log ratio values (scaled and centered within surveys) using MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text). Model names correspond to: null (intercept-only) model, linear model, linear model including survey as a fixed effect, generalized additive model (GAM), and GAM including survey as a random effect.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```

\clearpage

```{r tbl-models-alt}
null.altmhw <- lm(wt_mt_log_scale ~ 1, data = modeldat)
lm.altmhw <- lm(wt_mt_log_scale ~ anom_sev_scale_alt, data = modeldat)
lm.fixed.altmhw <- lm(wt_mt_log_scale ~ anom_sev_scale_alt + factor(survey), data = modeldat)
gam.altmhw <- gam(wt_mt_log_scale ~ s(anom_sev_scale_alt), data = modeldat )
gam.re.altmhw <- gam(wt_mt_log_scale ~ s(anom_sev_scale_alt) + s(survey, bs="re"), data = modeldat  %>% mutate(survey = as.factor(survey)))

# all of the ugly code below pulls out the correct table values from the models and formats them nicely so they don't have too many digits printed 
int.altmhw <- c(
  paste0(format(round(coef(summary(null.altmhw))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.altmhw))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.altmhw))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.altmhw))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.altmhw))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.altmhw))[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.altmhw)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.altmhw)$p.table[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.re.altmhw)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.re.altmhw)$p.table[1,2], digits=3), nsmall=2))
)
coef.altmhw <- c(
  "NA",
  paste0(format(round(coef(summary(lm.altmhw))[2,1], digits=3), nsmall=2)," ± ",
         format(round(coef(summary(lm.altmhw))[2,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.altmhw))[2,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.altmhw))[2,2]), digits=3), nsmall=2),
  "NA",
  "NA"
)
p.altmhw <- c(
  "NA",
  format(round(coef(summary(lm.altmhw))[2,4], digits=3), nsmall=2),
  format(round(coef(summary(lm.fixed.altmhw))[2,4], digits=3), nsmall=2),
  format(round(summary(gam.altmhw)$s.pv, digits=3), nsmall=2),
  format(round(summary(gam.re.altmhw)$s.pv[1], digits=3), nsmall=2)
)
r2.altmhw <- c('NA',format(round(c(
  summary(lm.altmhw)$r.squared, 
  summary(lm.fixed.altmhw)$r.squared,
  summary(gam.altmhw)$r.sq, 
  summary(gam.re.altmhw)$r.sq
), digits=3), nsmall=2))
aic.altmhw <- round(c(
  AIC(null.altmhw),
  AIC(lm.altmhw),
  AIC(lm.fixed.altmhw),
  AIC(gam.altmhw),
  AIC(gam.re.altmhw)
))
df.altmhw <- round(c(
  summary(null.altmhw)$df[2], 
  summary(lm.altmhw)$df[2], 
  summary(lm.fixed.altmhw)$df[2],
  gam.altmhw$df.residual, 
  gam.re.altmhw$df.residual
))


colnames.altmhw <- c('Null','LM','LM Survey','GAM','GAM Survey')
rownames.altmhw <- c('Intercept', 'MHW coefficient',"Coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

alt.tbl <- data.frame(rbind(int.altmhw, coef.altmhw, p.altmhw, r2.altmhw, aic.altmhw, df.altmhw), row.names=rownames.altmhw) 
colnames(alt.tbl) <- colnames.altmhw

# ±
kbl(alt.tbl, booktabs = TRUE, caption = "Models of biomass response to MHWs. This table is identical to Supp. Tab. 2, except rather than centering and scaling MHW severity within regions, it is centered and scaled among regions. The approach used in most of these models (centering and scaling MHW severity within regions) assumes that history matters in ecological responses to MHW responses, i.e., that biomass change should be compared to how anomalous a MHW is relative to other MHWs that occurred in the region. Here, we test the hypothesis that absolute MHW severity matters regardless of the oceangraphic history of each region (centering and scaling MHW severity among regions). All models were fitted to biomass log ratio values (scaled and centered within surveys) using MHW severity in days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text). Model names correspond to: null (intercept-only) model, linear model, linear model including survey as a fixed effect, generalized additive model (GAM), and GAM including survey as a random effect.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```

\clearpage

```{r tbl-models-lags}

gam1 = gam( wt_mt_log_scale ~ s(as.matrix(lags)[,2:3]), data=lags )
gam2 = gam( wt_mt_log_scale ~ s(as.matrix(lags)[,2:4]), data=lags )
gam3= gam( wt_mt_log_scale ~ s(as.matrix(lags)[,2:5]), data=lags )
gam4 =gam( wt_mt_log_scale ~ s(as.matrix(lags)[,2:6]), data=lags )

# int.lags <- c(
#   paste0(format(round(summary(gam1)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam1)$p.table[1,2], digits=3), nsmall=2)),
#   paste0(format(round(summary(gam2)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam2)$p.table[1,2], digits=3), nsmall=2)),
#   paste0(format(round(summary(gam3)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam3)$p.table[1,2], digits=3), nsmall=2)),
#   paste0(format(round(summary(gam4)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam4)$p.table[1,2], digits=3), nsmall=2))
# )
r2.lags <- format(round(c(
  summary(gam1)$r.sq,
  summary(gam2)$r.sq,
  summary(gam3)$r.sq,
  summary(gam4)$r.sq
), digits=3), nsmall=2)
aic.lags <- round(c(
  AIC(gam1),
  AIC(gam2),
  AIC(gam3),
  AIC(gam4)
))
df.lags <- round(c(
  gam1$df.residual, 
  gam2$df.residual,
  gam3$df.residual,
  gam4$df.residual
))
p.lags <- format(round(c(
  summary(gam1)$s.pv,
  summary(gam2)$s.pv,
  summary(gam3)$s.pv,
  summary(gam4)$s.pv),                     
  digits=3), 
  nsmall=2)

colnames.lags <- c('1-2 Years','1-3 Years','1-4 Years','1-5 Years')
rownames.lags <- c('p-value','R$^2$',"AIC","Degrees of freedom")

lags.tbl <- data.frame(rbind(p.lags, r2.lags, aic.lags, df.lags), row.names=rownames.lags) 
colnames(lags.tbl) <- colnames.lags

# ±
kbl(lags.tbl, booktabs = TRUE, caption = "Models of biomass response to lagged MHW effects. All models were fitted to biomass log ratio values (scaled and centered within surveys) using MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text). All models are generalized additive models (GAMs) that use a smoothed predictor matrix containing lagged MHW data for up to five years into the past.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```

\clearpage

```{r tbl-models-autocorr}
gompertz.glmm = glmmTMB(wt_mt_log ~ factor(survey) + anom_sev_scale + wt_mt_lag:factor(survey), data=modeldat, dispformula = ~survey, family=gaussian())
gompertz.null = glmmTMB(wt_mt_log ~ 1, data=modeldat, dispformula = ~survey, family=gaussian())

gompertz.summary <- summary(gompertz.glmm)$coefficients$cond

int.gompertz <- c(
  paste0(format(round(summary(gompertz.null)$coefficients$cond["(Intercept)","Estimate"] , digits=3), nsmall=2)," ± ", format(round(summary(gompertz.null)$coefficients$cond["(Intercept)","Std. Error"] , digits=3), nsmall=2)),
  paste0(format(round(gompertz.summary["(Intercept)","Estimate"] , digits=3), nsmall=2)," ± ", format(round(gompertz.summary["(Intercept)","Std. Error"] , digits=3), nsmall=2))) 

coef.gompertz <- c('NA',paste0(format(round(gompertz.summary["anom_sev_scale","Estimate"] , digits=3), nsmall=2)," ± ", format(round(gompertz.summary["anom_sev_scale","Std. Error"] , digits=3), nsmall=2)) )

p.gompertz <- c('NA',paste0(format(round(gompertz.summary["anom_sev_scale","Pr(>|z|)"] , digits=3), nsmall=2)))

r2.gompertz <- c('NA',format(round(unname(performance::r2_xu(gompertz.glmm)), digits=3), nsmall=2)) # see performance() documentation -- xu is one of the simpler and more flexible R2 metrics

aic.gompertz <- round(c(AIC(gompertz.null), AIC(gompertz.glmm)))

df.gompertz <- c(unname(summary(gompertz.null)$AICtab["df.resid"]),
                 unname(summary(gompertz.glmm)$AICtab["df.resid"]))


colnames.gompertz <- c('Null model','Gompertz GLM')
rownames.gompertz <- c('Intercept', 'MHW coefficient',"Coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

gompertz.tbl <- data.frame(rbind(int.gompertz, coef.gompertz, p.gompertz, r2.gompertz, aic.gompertz, df.gompertz), row.names=rownames.gompertz) 
colnames(gompertz.tbl) <- colnames.gompertz

# ±
kbl(gompertz.tbl, booktabs = TRUE, caption = "Null (intercept-only) model and generalized linear model (GLM) of biomass as a function of MHWs and biomass from the previous time step. This Gompertz model accounts for autoregressive properties of the biomass time-series. It predicts biomass log ratios with MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text) and lagged biomass (not scaled and centered). To account for variability and heteroskedasticity among surveys, we included survey identity as a fixed effect and allowed dispersion to vary among surveys.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))

```

\clearpage

```{r tbl-models-lat}
null.lat <- lm(wt_mt_log_scale ~ med_lat_scale, data = modeldat)
lm.lat <- lm(wt_mt_log_scale ~ anom_sev_scale + med_lat_scale, data = modeldat)

int.lat <- c(
  paste0(format(round(coef(summary(null.lat))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.lat))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.lat))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.lat))[1,2], digits=3), nsmall=2))
)
mhw.coef.lat <- c('NA',
                  paste0(format(round(coef(summary(lm.lat))[2,1], digits=3), nsmall=2)," ± ",
                         format(round(coef(summary(lm.lat))[2,2], digits=3), nsmall=2))
)
lat.coef.lat <- c('NA',
                  paste0(format(round(coef(summary(lm.lat))[3,1], digits=3), nsmall=2)," ± ",
                         format(round(coef(summary(lm.lat))[3,2], digits=3), nsmall=2))
)
p.lat <- c('NA',format(round(c(
  coef(summary(lm.lat))[2,4]), digits=3), nsmall=2))

r2.lat <- c('NA',format(round(c(
  summary(lm.lat)$r.squared), digits=3), nsmall=2))
aic.lat <- round(c(AIC(null.lat), AIC(lm.lat)))
df.lat <- round(c(
    summary(null.lat)$df[2],
    summary(lm.lat)$df[2]))

colnames.lat <- c('Null model','Linear model')
rownames.lat <- c('Intercept', 'MHW coefficient','Latitude coefficient', "MHW coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

lat.tbl <- data.frame(rbind(int.lat, mhw.coef.lat, lat.coef.lat, p.lat, r2.lat, aic.lat, df.lat), row.names=rownames.lat) 
colnames(lat.tbl) <- colnames.lat

kbl(lat.tbl, booktabs = TRUE, caption = "Null model (latitude-only) and model of biomass response to MHWs and latitude. Linear model was fitted to biomass log ratio values (scaled and centered within surveys) using MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text) and median latitude of each survey (scaled and centered within surveys) as predictors.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```


```{r tbl-models-fish}
null.fish <- lm(wt_mt_log_scale ~ f_fmsy_scale, data = sau)
lm.lat <- lm(wt_mt_log_scale ~ anom_sev_scale + med_lat_scale, data = sau)

int.lat <- c(
  paste0(format(round(coef(summary(null.lat))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.lat))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.lat))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.lat))[1,2], digits=3), nsmall=2))
)
mhw.coef.lat <- c('NA',
                  paste0(format(round(coef(summary(lm.lat))[2,1], digits=3), nsmall=2)," ± ",
                         format(round(coef(summary(lm.lat))[2,2], digits=3), nsmall=2))
)
lat.coef.lat <- c('NA',
                  paste0(format(round(coef(summary(lm.lat))[3,1], digits=3), nsmall=2)," ± ",
                         format(round(coef(summary(lm.lat))[3,2], digits=3), nsmall=2))
)
p.lat <- c('NA',format(round(c(
  coef(summary(lm.lat))[2,4]), digits=3), nsmall=2))

r2.lat <- c('NA',format(round(c(
  summary(lm.lat)$r.squared), digits=3), nsmall=2))
aic.lat <- round(c(AIC(null.lat), AIC(lm.lat)))
df.lat <- round(c(
    summary(null.lat)$df[2],
    summary(lm.lat)$df[2]))

colnames.lat <- c('Null model','Linear model')
rownames.lat <- c('Intercept', 'MHW coefficient','Latitude coefficient', "MHW coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

lat.tbl <- data.frame(rbind(int.lat, mhw.coef.lat, lat.coef.lat, p.lat, r2.lat, aic.lat, df.lat), row.names=rownames.lat) 
colnames(lat.tbl) <- colnames.lat

kbl(lat.tbl, booktabs = TRUE, caption = "Null model (latitude-only) and model of biomass response to MHWs and latitude. Linear model was fitted to biomass log ratio values (scaled and centered within surveys) using MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text) and median latitude of each survey (scaled and centered within surveys) as predictors.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))
```

\clearpage

```{r tbl-models-depth}
null.depth <- lm(depth_wt_scale ~ 1, data = modeldat)
lm.depth <- lm(depth_wt_scale ~ anom_sev_scale, data = modeldat)

int.depth <- c(
  paste0(format(round(coef(summary(null.depth))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.depth))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.depth))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.depth))[1,2], digits=3), nsmall=2))
)
coef.depth <- c('NA',
                paste0(format(round(coef(summary(lm.depth))[2,1], digits=3), nsmall=2)," ± ",
                       format(round(coef(summary(lm.depth))[2,2], digits=3), nsmall=2))
)
p.depth <- c('NA',format(round(c(
  coef(summary(lm.depth))[2,4]), digits=3), nsmall=2))
r2.depth <- c('NA',format(round(c(
  summary(lm.depth)$r.squared), digits=3), nsmall=2))
aic.depth <- round(c(AIC(null.depth), AIC(lm.depth)))
df.depth <- round(c(
    summary(null.depth)$df[2],
    summary(lm.depth)$df[2]))

colnames.depth <- c('Null model','Linear model')
rownames.depth <- c('Intercept', 'MHW coefficient',"Coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

depth.tbl <- data.frame(rbind(int.depth, coef.depth, p.depth, r2.depth, aic.depth, df.depth), row.names=rownames.depth) 
colnames(depth.tbl) <- colnames.depth

kbl(depth.tbl, booktabs = TRUE, caption = "Null (intercept-only) model and model of depth response to MHWs. Linear model was fitted to the weighted mean depth of the fish assemblage (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text) using MHW severity in °C days (scaled and centered within surveys).",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))

```

\clearpage

```{r tbl-models-cti}
null.cti <- lm(cti_diff_scale ~ 1, data = modeldat)
lm.cti <- lm(cti_diff_scale ~ anom_sev_scale, data = modeldat)
lm.fixed.cti <- lm(cti_diff_scale ~ anom_sev_scale + factor(survey), data = modeldat)
gam.cti <- gam(cti_diff_scale ~ s(anom_sev_scale), data = modeldat )
gam.re.cti <- gam(cti_diff_scale ~ s(anom_sev_scale) + s(survey, bs="re"), data = modeldat  %>% mutate(survey = as.factor(survey)))

# all of the ugly code below pulls out the correct table values from the models and formats them nicely so they don't have too many digits printed 
int.cti <- c(
  paste0(format(round(coef(summary(null.cti))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(null.cti))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.cti))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.cti))[1,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.cti))[1,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.cti))[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.cti)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.cti)$p.table[1,2], digits=3), nsmall=2)),
  paste0(format(round(summary(gam.re.cti)$p.table[1,1], digits=3), nsmall=2)," ± ", format(round(summary(gam.re.cti)$p.table[1,2], digits=3), nsmall=2))
)
coef.cti <- c(
  'NA',
  paste0(format(round(coef(summary(lm.cti))[2,1], digits=3), nsmall=2)," ± ",
         format(round(coef(summary(lm.cti))[2,2], digits=3), nsmall=2)),
  paste0(format(round(coef(summary(lm.fixed.cti))[2,1], digits=3), nsmall=2)," ± ", format(round(coef(summary(lm.fixed.cti))[2,2]), digits=3), nsmall=2),
  "NA",
  "NA"
)
p.cti <- c('NA',
  format(round(coef(summary(lm.cti))[2,4], digits=3), nsmall=2),
  format(round(coef(summary(lm.fixed.cti))[2,4], digits=3), nsmall=2),
  format(round(summary(gam.cti)$s.pv, digits=3), nsmall=2),
  format(round(summary(gam.re.cti)$s.pv[1], digits=3), nsmall=2)
)
r2.cti <- c('NA',format(round(c(
  summary(lm.cti)$r.squared, 
  summary(lm.fixed.cti)$r.squared,
  summary(gam.cti)$r.sq, 
  summary(gam.re.cti)$r.sq
), digits=3), nsmall=2))
aic.cti <- format(round(c(
  AIC(null.cti),
  AIC(lm.cti),
  AIC(lm.fixed.cti),
  AIC(gam.cti),
  AIC(gam.re.cti)
), digits=3), nsmall=0)
df.cti <- format(round(c(
    summary(null.cti)$df[2], 
summary(lm.cti)$df[2], 
  summary(lm.fixed.cti)$df[2],
  gam.cti$df.residual, 
  gam.re.cti$df.residual
), digits=3), nsmall=0)


colnames.cti <- c('Null','LM','LM Survey','GAM','GAM Survey')
rownames.cti <- c('Intercept', 'MHW coefficient',"Coefficient p-value",'R$^2$',"AIC","Degrees of freedom")

cti.tbl <- data.frame(rbind(int.cti, coef.cti, p.cti, r2.cti, aic.cti, df.cti), row.names=rownames.cti) 
colnames(cti.tbl) <- colnames.cti

# ±
kbl(cti.tbl, booktabs = TRUE, caption = "Models of Community Temperature Index (CTI) response to MHWs. All models were fitted to CTI year-over-year difference values (scaled and centered within surveys) using MHW severity in °C days (scaled and centered within surveys, calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text). Model names correspond to: null (intercept-only) model, linear model, linear model including survey as a fixed effect, generalized additive model (GAM), and GAM including survey as a random effect.",
    escape = FALSE) %>%
  kable_styling(font_size = 8, latex_options = c("striped"))

```

\clearpage

# Supplementary figures: sensitivity of main results to metrics and methods

```{r fig-mhw-point-by-reg, fig.cap="Alternate version of Fig. 2 from the main text, showing results by region. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Points represent log ratios of mean biomass in a survey from one year to the next. The fitted lines are linear regressions. The shaded areas are 95% confidence intervals. Survey names are listed in Supp. Tab. 1.", fig.width=9, fig.height=7}
gg_mhw_biomass_point <- survey_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
  ggplot(aes(x=anom_sev, y=wt_mt_log)) +
  geom_point() +
  geom_smooth(method="lm", color = "gray35") +
  facet_wrap(~survey, ncol=4) +
  theme_bw() +
  coord_cartesian(clip = "off") +
  labs(x="MHW severity (°C days)", y="Biomass log ratio") +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=50, label.y=1) +
  NULL
gg_mhw_biomass_point
```

```{r fig-mhw-point-by-cpue-method, fig.cap="Alternate version of Fig. 2 from the main text using different metrics of biomass change: mean biomass (used in the main text), median biomass, mean abundance, and median abundance. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Points represent log ratios of each metric in a survey from one year to the next. The fitted lines are linear regressions. The shaded areas are 95% confidence intervals. The Northeast US survey is omitted because it does not have abundance data recorded.", fig.width=9, fig.height=7}
gg_mhw_cpue_metric_point <- survey_summary %>% 
  filter(!survey=='NEUS') %>% 
  mutate_at(c("num_log_med","wt_mt_log_med"), as.numeric) %>% # no idea why this is a character
  inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
  pivot_longer(cols=c(num_log, num_log_med, wt_mt_log, wt_mt_log_med), names_to = "method", values_to="lr") %>% 
  mutate(method  = recode(method, 
         num_log = "Mean Abundance", 
         num_log_med = "Median Abundance", 
         wt_mt_log = "Mean Biomass", 
         wt_mt_log_med="Median Biomass")) %>% 
  ggplot(aes(x=anom_sev, y=lr)) +
  geom_point() +
  geom_smooth(method="lm", color = "gray35") +
  theme_bw() +
  coord_cartesian(clip = "off") +
  facet_wrap(~method, ncol=2) +
  labs(x="MHW severity (°C days)", y="Log ratio") +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=50) +
  NULL
gg_mhw_cpue_metric_point
```

```{r fig-mhw-incidence, fig.cap="MHW severity (total anomaly in °C days) in each survey region with and without detrending the temperature data to remove the signal of secular warming. The main text results are detrended. Here, we plot MHW severity based on all SBT anomalies from GLORYS, rather than applying the five-day threshold that was used the main text, to more clearly show the differences between the two methods."}

tmpdat <- mhw_summary_glorys_d %>% 
  mutate(group = "Detrended") %>% 
  bind_rows(mhw_summary_glorys_nod %>% mutate(group = "Not Detrended"))

gg_mhw_incidence <- survey_summary %>% 
  inner_join(tmpdat, by="ref_yr") %>%
  ggplot(aes(x=year, y=anom_sev, group=group, color=group)) + 
  scale_color_manual(values=c(cbpal6[3], cbpal6[4]))+ 
  geom_line() + 
  facet_wrap(~survey, scales="free_y", ncol=4)+
  theme_bw() +
  labs(x="Year",y="MHW Severity") +
  theme(legend.title = element_blank(),
        legend.position = "bottom")
  
gg_mhw_incidence
```

```{r fig-mhw-detrending, fig.cap="Alternate version of Fig. 2 from the main text, showing biomass change (log ratio) and MHW severity (total anomaly in °C days, using GLORYS data with the five-day MHW threshold) calculated from non-detrended data. The fitted lines are linear regressions. The shaded areas are 95% confidence intervals."}

gg_mhw_detrending <- survey_summary %>% 
  inner_join(mhw_summary_glorys_nod_5_day, by="ref_yr") %>%
  ggplot(aes(x=anom_sev, y=wt_mt_log)) + 
  geom_point() +
  theme_bw() + 
  geom_smooth(method="lm", color = "gray35") +
  labs(x="Non-detrended MHW severity (°C days)", y="Biomass log ratio") +
  stat_regline_equation(aes(label=..rr.label..), label.x=25, label.y=2.25) +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") 
  
gg_mhw_detrending
```

```{r fig-mhw-summer, fig.cap="Alternate version of Fig. 2 from the main text, showing biomass change (log ratio) and MHW severity (total anomaly in °C days, using GLORYS data without the five-day MHW threshold) based on only summer temperature anomalies (June, July, and August in the Northern Hemisphere). The fitted lines are linear regressions. The shaded areas are 95% confidence intervals."}

gg_mhw_summer <- survey_summary %>% 
  inner_join(mhw_summary_glorys_d_any_summer, by="ref_yr") %>%
  ggplot(aes(x=anom_sev, y=wt_mt_log)) + 
  geom_point() +
  theme_bw() + 
  geom_smooth(method="lm", color = "gray35") +
  labs(x="Summer-only MHW severity (°C days)", y="Biomass log ratio") +
  stat_regline_equation(aes(label=..rr.label..), label.x=15, label.y=1.5) +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") 
  
gg_mhw_summer
```

```{r fig-mhw-metric, fig.cap="Biomass change (log ratio) and two alternative metrics of MHW impacts: duration (total number of MHW-days), and intensity (severity divided by duration, i.e., the average anomaly over the course of the MHW in °C) calculated from the detrended GLORYS sea bottom temperature data with a minimum MHW duration of five days. The fitted lines are linear regressions. The shaded areas are 95% confidence intervals." }
gg_mhw_metric <- survey_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
  pivot_longer(cols=c(anom_days, anom_int), values_to = "value", names_to = "metric") %>% 
  mutate(metric = recode(metric, anom_days= 'Duration (days)',anom_int= 'Intensity (°C)')) %>% 
  ggplot(aes(x=value, y=wt_mt_log)) +
  geom_point() + 
  geom_smooth(method="lm", color = "gray35") +
  facet_wrap(~metric, scales="free_x") +
  stat_regline_equation(aes(label=..rr.label..), label.y=-2) +
  labs(x="MHW metric",y="Biomass log ratio") +
  theme_bw() + 
  NULL
gg_mhw_metric
```

```{r fig-mhw-source, fig.cap="Daily 95th percentile anomalies in the two MHW data sources: sea surface temperature from OISST and sea bottom temperature from GLORYS (both detrended). To simplify comparison we plot all anomalies, not just those MHWs that exceeded a five-day threshold. Note that the OISST time-series began in 1982 and GLORYS began in 1993. Region names are listed in Supp. Tab. 1."}

gg_mhw_source <- ggplot(data=rawsourcedat %>% filter(date<="2019-12-31")) + 
  geom_point(aes(x=date, y=anom, color=source, fill=source), position="jitter", alpha=0.25, size=0.5) +
  theme_classic() +
  labs(x="Date", y="Detrended temperature anomaly", fill="Dataset", color="Dataset") +
  facet_wrap(~survey) +
    scale_color_manual(values=cbpal6[3:4]) +
    scale_fill_manual(values=cbpal6[3:4]) +
  theme(legend.position = "bottom")

gg_mhw_source
```
\clearpage

# Supplementary figures: exploring additional predictors

```{r fig-abs-biomass, fig.cap="MHW severity (total anomaly in °C days) and absolute value of biomass log ratio. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. The fitted line is a linear regression. The shaded area is its 95% confidence interval."}

gg_mhw_biomass_point_abs <- survey_summary %>% 
  inner_join (mhw_summary_glorys_d_5_day, by="ref_yr") %>% # get MHW data matched to surveys
  ggplot(aes(x=anom_sev, y=abs(wt_mt_log))) +
  geom_point() +
  theme_bw() + 
  geom_smooth(method="lm", color = "gray35") +
  labs(x="MHW severity (°C days)", y="Absolute biomass log ratio") +
  stat_regline_equation(aes(label=..rr.label..), label.x=25, label.y=2.25) +
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") 
gg_mhw_biomass_point_abs

```

```{r fig-depth-point, fig.cap="Fish assemblage depth change (log ratio) and MHW severity (total anomaly in °C days). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. The fitted line is a linear regression. The shaded area is its 95% confidence interval."}
gg_mhw_biomass_point_depth <- survey_summary %>% inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% # get MHW data matched to surveys 
  ggplot(aes(x=anom_sev, y=depth_wt_log, fill=wt_mt_log, color=wt_mt_log, group=mhw_yes_no)) + 
  geom_point(position = "jitter") + 
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  coord_cartesian(clip = "off") + 
  labs(x="Marine heatwave severity (°C days)", y="Depth log ratio", fill="Biomass log ratio",color="Biomass log ratio") + scale_color_viridis_c() + scale_fill_viridis_c() + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  stat_regline_equation(aes(label=..rr.label..), label.y=0.5, label.x=25)

gg_mhw_biomass_point_depth # lm estimate is 0.3 with SE 0.16, p = 0.0575

```

```{r fig-depth-hist, fig.cap="Fish assemblage depth change (log ratio) and MHW occurrence. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text."}

gg_mhw_biomass_hist_depth <- survey_summary %>% inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% # get MHW data matched to surveys 
  mutate(mhw_yes_no = recode(mhw_yes_no, no="No MHW", yes="MHW")) %>% 
  ggplot(aes(x=depth_wt_log, group=mhw_yes_no, fill=mhw_yes_no, color=mhw_yes_no)) + geom_freqpoly(binwidth=0.1, alpha=0.8, size=2) + 
  scale_color_manual(values=c("#E31A1C","#1F78B4")) + 
  scale_fill_manual(values=c("#E31A1C","#1F78B4")) + 
  theme_bw() + 
  labs(x="Depth log ratio", y="Frequency") + 
  theme(legend.position = "right", legend.title = element_blank(), panel.grid.major = element_blank(), panel.grid.minor = element_blank()) 

gg_mhw_biomass_hist_depth
```

```{r fig-lat-point, fig.cap="Biomass change (log ratio) and MHW severity (total anomaly in °C days), color-coded by median latitude of each survey region. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. The fitted line is a linear regression. The shaded area is its 95% confidence interval."}
med_lat <- haul_info %>% group_by(survey) %>% summarise(med_lat = median(latitude))

gg_mhw_biomass_point_latitude <- survey_summary %>% inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% # get MHW data matched to surveys
  left_join(med_lat)%>% 
  ggplot(aes(x=anom_sev, y=wt_mt_log, fill=med_lat, color=med_lat)) +
  geom_point(position = "jitter") + 
  theme_bw() + coord_cartesian(clip = "off") + 
  labs(x="Marine heatwave severity (°C days)", y="Biomass log ratio", fill='Median latitude', color='Median latitude') + 
  scale_color_viridis_c() + 
  scale_fill_viridis_c() + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black")+
  geom_smooth(method="lm", color="gray35")+
  stat_regline_equation(aes(label=..rr.label..))

gg_mhw_biomass_point_latitude

```

```{r fig-lag-point, fig.cap="Biomass change (log ratio) and MHW severity (total anomaly in °C days) calculated the preceding year as in the main text (0-12 months), a one-year lag (12-24 months), and a two-year lag (24-36 months). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Fitted lines are linear regressions. Shaded areas are 95% confidence intervals."}

gg_mhw_biomass_point_lags <- survey_summary %>% 
  inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
  filter(!survey %in% c('AI','GOA')) %>% 
  group_by(survey) %>% 
  arrange(year) %>% 
  mutate(anom_sev_lag1 = lag(anom_sev, n=1), anom_sev_lag2 = lag(anom_sev, n=2)) %>% select(survey, wt_mt_log, anom_sev, anom_sev_lag1, anom_sev_lag2) %>% pivot_longer(cols=c(anom_sev, anom_sev_lag1, anom_sev_lag2), names_to="lag", values_to="anomaly_days") %>% 
  mutate(lag = recode(lag, anom_sev = "0_12",anom_sev_lag1= "12_24",anom_sev_lag2="24_36")) %>% 
  ggplot(aes(x=anomaly_days, y=wt_mt_log)) + 
  geom_point() + geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  coord_cartesian(clip = "off") + 
  labs(x="MHW severity (°C days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) + 
  facet_wrap(~lag) +
  stat_regline_equation(aes(label=..rr.label..), label.x=40)

gg_mhw_biomass_point_lags
```

```{r fig-spp-tl, fig.cap="Biomass log ratio and MHW severity (total anomaly in °C days) grouped by trophic level of each taxon. Trophic levels are binned (2-3, 3-4, and 4-5). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Fitted lines are linear regressions. Shaded areas are 95% confidence intervals."}

ggplot(tl %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_sev, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~tl_cat) +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=40)

```

```{r fig-spp-feed, fig.cap="Biomass log ratio and MHW severity (total anomaly in °C days) grouped by feeding mode of each taxon. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Fitted lines are linear regressions. Shaded areas are 95% confidence intervals."}

ggplot(feed %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_sev, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~feeding.mode, ncol=3) +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x = 40, label.y = 10)

```

```{r fig-spp-hab, fig.cap="Biomass log ratio and MHW severity (total anomaly in °C days) grouped by habitat preference of each taxon. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Fitted lines are linear regressions. Shaded areas are 95% confidence intervals."}

ggplot(hab %>% filter(wt_mt_log < Inf & wt_mt_log > -Inf), aes(x=anom_sev, y=wt_mt_log) )+
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  facet_wrap(~habitat, ncol=3) +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Biomass log ratio") + 
  geom_hline(aes(yintercept=0), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=40, label.y=10)

```

\clearpage

# Supplementary figures: community dissimilarity 

```{r fig-dissim-mhw, fig.cap="Box-and-whisker plots of temporal community dissimilarity and MHW incidence for partitioned occurence-based beta diversity metrics (Jaccard turnover and nestedness; top) and partitioned biomass-based beta diversity metrics (Bray-Curtis balanced variation and biomass gradient; bottom). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text."}

#convert mhw_yes_no to factor
beta_div$mhw_yes_no <- factor(beta_div$mhw_yes_no)

#Turnover Component

MHW_jaccard_dissimilarity_turnover <- ggplot(beta_div %>% filter(complete.cases(mhw_yes_no)), aes(x=mhw_yes_no, y=jaccard_dissimilarity_turnover)) +
  geom_boxplot(outlier.size=0.5, outlier.fill="grey70", outlier.color="grey30", outlier.alpha=0.5) +
  theme_bw() + 
  labs(x="Marine Heatwave", y="Turnover Component\nJaccard Dissimilarity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

#Nestedness Component

MHW_jaccard_dissimilarity_nestedness <- ggplot(beta_div %>% filter(complete.cases(mhw_yes_no)), aes(x=mhw_yes_no, y=jaccard_dissimilarity_nestedness)) +
  geom_boxplot(outlier.size=0.5, outlier.fill="grey70", outlier.color="grey30", outlier.alpha=0.5) +
  theme_bw() + 
  labs(x="Marine Heatwave", y="Nestedness Component\nJaccard Dissimilarity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

#Balanced Variation Component (we use 'turnover' as variable name for easier parallel with Jaccard metrics)

MHW_bray_dissimilarity_turnover <- ggplot(beta_div %>% filter(complete.cases(mhw_yes_no)), aes(x=mhw_yes_no, y=bray_dissimilarity_turnover)) +
  geom_boxplot(outlier.size=0.5, outlier.fill="grey70", outlier.color="grey30", outlier.alpha=0.5) +
  theme_bw() + 
  labs(x="Marine Heatwave", y="Balanced Variation Component\nBray-Curtis Dissimilarity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

#Biomass Gradient Component (we use 'nestedness' as variable name for easier parallel with Jaccard metrics)

MHW_bray_dissimilarity_nestedness <- ggplot(beta_div %>% filter(complete.cases(mhw_yes_no)), aes(x=mhw_yes_no, y=bray_dissimilarity_nestedness)) +
  geom_boxplot(outlier.size=0.5, outlier.fill="grey70", outlier.color="grey30", outlier.alpha=0.5) +
  theme_bw() + 
  labs(x="Marine Heatwave", y="Biomass Gradient Component\nBray-Curtis Dissimilarity") + 
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank())

plot_grid(MHW_jaccard_dissimilarity_turnover + theme(axis.title.x = element_blank()),
          MHW_jaccard_dissimilarity_nestedness  + theme(axis.title.x = element_blank()),
          MHW_bray_dissimilarity_turnover,
          MHW_bray_dissimilarity_nestedness,
          ncol = 2, nrow = 2,
          align = "hv")
```

```{r fig-dissim-length, fig.cap="Temporal community dissimilarity and MHW severity (total anomaly in °C days) for partitioned occurrence-based beta diversity metrics (Jaccard turnover and nestedness; top) and partitioned biomass-based beta diversity metrics (Bray-Curtis balanced variation and biomass gradient; bottom). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Fitted lines are linear regressions. Shaded areas are 95% confidence intervals."}

#Turnover Component

anom_sev_jaccard_dissimilarity_turnover <- ggplot(beta_div, aes(x=anom_sev, y=jaccard_dissimilarity_turnover)) +
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Turnover Component\nJaccard Dissimilarity") + 
  geom_hline(aes(yintercept=mean(jaccard_dissimilarity_turnover, na.rm = T)), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=100) 

#Nestedness Component

anom_sev_jaccard_dissimilarity_nestedness <- ggplot(beta_div, aes(x=anom_sev, y=jaccard_dissimilarity_nestedness)) +
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Nestedness Component\nJaccard Dissimilarity") + 
  geom_hline(aes(yintercept=mean(jaccard_dissimilarity_nestedness, na.rm = T)), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=100) 

#Balanced Variation Component (we use 'turnover' as variable name for easier parallel with Jaccard metrics)

anom_sev_bray_dissimilarity_turnover <- ggplot(beta_div, aes(x=anom_sev, y=bray_dissimilarity_turnover)) +
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Balanced Variation Component\nBray-Curtis Dissimilarity") + 
  geom_hline(aes(yintercept=mean(bray_dissimilarity_turnover, na.rm = T)), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=100) 

#Biomass Gradient Component (we use 'nestedness' as variable name for easier parallel with Jaccard metrics)

anom_sev_bray_dissimilarity_nestedness <- ggplot(beta_div, aes(x=anom_sev, y=bray_dissimilarity_nestedness)) +
  geom_point(size=0.5, fill="grey70", color="grey30", alpha=0.5, position = "jitter") +
  geom_smooth(method="lm", color = "gray35") + 
  theme_bw() + 
  labs(x="MHW severity (°C days)", y="Biomass Gradient Component\nBray-Curtis Dissimilarity") + 
  geom_hline(aes(yintercept=mean(bray_dissimilarity_nestedness, na.rm = T)), linetype="dashed", color="black") +
  theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank()) +
  stat_regline_equation(aes(label=..rr.label..), label.x=100) 

plot_grid(anom_sev_jaccard_dissimilarity_turnover + theme(axis.title.x = element_blank()),
          anom_sev_jaccard_dissimilarity_nestedness  + theme(axis.title.x = element_blank()),
          anom_sev_bray_dissimilarity_turnover,
          anom_sev_bray_dissimilarity_nestedness,
          ncol = 2, nrow = 2,
          align = "hv")
```

\clearpage

# Supplementary figures: power analysis

```{r fig-power-yrs-glorys, fig.cap="Results from a power analysis applying our methods to a simulated dataset in which MHWs reduce biomass by 6% and study duration is varied. The sample sizes plotted are total survey-years across all regions. Dashed vertical line shows the sample size of our actual dataset. Dashed horizontal line denotes one conventionally accepted threshold for power (0.8). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Simulations were run to 200 years per survey (3600 total survey-years across the 18 regions) but truncated in this figure after power saturated at 1.0."}
gg_power_yrs_glorys <- sim_test_summ_yrs_glorys %>% 
  filter(n_years <= 110) %>% 
  ggplot(aes(x=n_years_tot, y=propsig)) +
  geom_area(fill="grey30", alpha=0.7, color="grey30") +
  geom_hline(aes(yintercept=0.8), color="black", linetype='dashed') + geom_vline(aes(xintercept=nrow(survey_summary %>%                                                   inner_join(mhw_summary_glorys_d_5_day, by="ref_yr"))), color="black", linetype='dashed') +
  labs(x="Sample size (survey-years)", y="Power", title='GLORYS')+
  theme_bw() +
  scale_y_continuous(limits=c(0, 1))
gg_power_yrs_glorys
```

```{r fig-power-yrs-oisst, fig.cap="Results from a power analysis applying our methods to a simulated dataset in which MHWs reduce biomass by 6% and study duration is varied. The sample sizes plotted are total survey-years across all regions. Dashed vertical line shows the sample size of our actual dataset. Dashed horizontal line denotes one conventionally accepted threshold for power (0.8). MHWs were calculated from the detrended OISST sea surface temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. Simulations were run to 200 years per survey (3600 total survey-years across the 18 regions) but truncated in this figure after power saturated at 1.0."}
gg_power_yrs_oisst <- sim_test_summ_yrs_oisst %>% 
  filter(n_years <= 110) %>% 
  ggplot(aes(x=n_years_tot, y=propsig)) +
  geom_area(fill="grey30", alpha=0.7, color="grey30") +
  geom_hline(aes(yintercept=0.8), color="black", linetype='dashed') + geom_vline(aes(xintercept=nrow(survey_summary %>%                                                   inner_join(mhw_summary_glorys_d_5_day, by="ref_yr"))), color="black", linetype='dashed') +
  labs(x="Sample size (survey-years)", y="Power", title="OISST")+
  theme_bw() +
  scale_y_continuous(limits=c(0, 1))
gg_power_yrs_oisst
```


```{r fig-power-gamma-glorys, fig.cap="Results from a power analysis applying our methods to a simulated dataset that varied the MHW effect on biomass over the true number of survey-years for each region in our dataset. The sample sizes plotted are total survey-years across all regions. Dashed horizontal line denotes one conventionally accepted threshold for power (0.8). MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text."}
gg_power_gamma_glorys <- sim_test_summ_gamma_glorys %>% 
  mutate(pct = (1-exp_gamma)*100) %>% 
  ggplot(aes(x=pct, y=propsig)) +
  geom_area(fill="grey30", alpha=0.7, color="grey30") +
  geom_hline(aes(yintercept=0.8), color="black", linetype='dashed') +
  labs(x="MHW effect on biomass (%)", y="Power", title="GLORYS")+
  theme_bw() +
  scale_y_continuous(limits=c(0, 1))
gg_power_gamma_glorys
```


```{r fig-power-gamma-oisst, fig.cap="Results from a power analysis applying our methods to a simulated dataset that varied the MHW effect on biomass over the true number of survey-years for each region in our dataset. The sample sizes plotted are total survey-years across all regions. Dashed horizontal line denotes one conventionally accepted threshold for power (0.8). MHWs were calculated from the detrended OISST sea surface temperature data with a five-day minimum duration threshold for MHWs, as used in the main text."}
gg_power_gamma_oisst <- sim_test_summ_gamma_oisst %>% 
  mutate(pct = (1-exp_gamma)*100) %>% 
  ggplot(aes(x=pct, y=propsig)) +
  geom_area(fill="grey30", alpha=0.7, color="grey30") +
  geom_hline(aes(yintercept=0.8), color="black", linetype='dashed') +
  labs(x="MHW effect on biomass (%)", y="Power", title="OISST")+
  theme_bw() +
  scale_y_continuous(limits=c(0, 1))
gg_power_gamma_oisst
```
\clearpage

# Supplementary figures: regional time-series 

```{r fig-spp, fig.keep="all", fig.height=4, fig.cap=paste0("Biomass trends and historical MHWs by region. MHWs were calculated from the detrended GLORYS sea bottom temperature data with a five-day minimum duration threshold for MHWs, as used in the main text. The top five taxa by biomass are highlighted. Shaded grey rectangles denote when any MHWs occurred in the preceding survey-year (e.g., 2015 in the Eastern Bering Sea time-series corresponds to the survey that began in June 2015, and MHW data from June 2014 - May 2015). British Columbia and the Gulf of Alaska are biennial surveys; all others are annual."), message = F, echo = F, warning = F}

plot_spp <- function(x){
  topspp <- survey_spp_summary %>% 
    filter(survey == x) %>% 
    group_by(spp, survey) %>% 
    summarise(tot = sum(wt_mt)) %>% 
    ungroup() %>% 
    arrange(-tot) %>% 
    slice(1:5) 
  
  plot_prep <- survey_spp_summary %>% 
    filter(survey == topspp$survey, spp %in% topspp$spp) %>% 
    group_by(year, spp, ref_yr, survey) %>% 
    summarise(wt_mt = sum(wt_mt)) %>% 
    ungroup() %>% 
    bind_rows(survey_spp_summary %>% filter(survey == topspp$survey, !spp %in% topspp$spp) %>% group_by(year, ref_yr, survey) %>% summarise(wt_mt = sum(wt_mt)) %>% mutate(spp="Others")) %>% 
    inner_join(mhw_summary_glorys_d_5_day, by="ref_yr") %>% 
    group_by(survey, year) %>% 
    mutate(tot = sum(wt_mt)) %>% # set up height for MHW rectangle
    group_by(survey) %>% 
    mutate(maxtot = max(tot)) %>% 
    ungroup() %>% 
    mutate(bar1 = ifelse(mhw_yes_no == "yes", maxtot, 0)) %>% 
    left_join(survey_names) %>% 
    mutate(spp = factor(spp, levels=c(topspp$spp, "Others")))
  
  reg_plot <-  ggplot() +
    geom_area(data=plot_prep, aes(x=year, y=wt_mt, color=spp, fill=spp, group=spp)) + 
    geom_col(data=plot_prep %>% select(year, bar1) %>% distinct(), aes(x=year, y=bar1), color="transparent", fill="grey70", alpha=0.5) +
    scale_color_manual(values=cbpal6) +
    scale_fill_manual(values=cbpal6) +
    theme_bw() + 
    theme(panel.grid.major = element_blank(), panel.grid.minor = element_blank(),
          legend.position="right",
          legend.title = element_blank()) + 
    labs(x="Year",y="Biomass (mt)", title=survey_names[survey_names$survey==x,]$title) +
    NULL
  
  
  #print plot
  cat('\n\n') 
  print(reg_plot)
  #space
  cat('\n\n') 
  
}

walk(survey_names$survey, ~plot_spp(.x))

```

\clearpage

# References
