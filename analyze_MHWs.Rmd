---
title: "Analyzing MHW effects on fish abundance in trawl surveys"
author: "Alexa Fredston"
date: "3/23/2021"
output: 
  github_document: default
---

# North America

Note that as of 05-20-2021, I've updated the analysis such that every survey is compared to MHW data from the 12 months preceding the earliest start month of the survey. Different seasons in a region are pooled, so e.g., the spring and fall NEUS surveys are compared to data from the 365 days before February 1 of each survey-year.

```{r include=FALSE}
knitr::opts_chunk$set(eval=TRUE, echo=FALSE, results=TRUE, message=FALSE, warning=FALSE) # set options for all chunks
```

```{r packages, results=FALSE}
library(tidyverse)
library(here)
library(lubridate) # for standardizing date format of MHW data
library(kableExtra)
```

```{r data, results=FALSE}
mhwSurvSummary <- read_csv(here("processed-data","survey_MHW_summary_stats.csv"))
mhwYrTidy <- read_csv(here("processed-data","MHW_calendar_year_anomaly.csv"))
namerSummary <-read_csv(here("processed-data","survey_region_biomass_with_MHWs.csv"))
namerSppSummary <- read_csv(here("processed-data","survey_species_biomass_with_MHWs.csv"))
survey_start_times <- read_csv(here("processed-data","survey_start_times.csv"))
```

## Plots

### Net changes in biomass

Let's plot several marine heatwave indices against several CPUE indices, to see how similar patterns are across metrics. I'm also looking for whether we see effects of major known MHW events: 2012 in the Northeast, the 2014-2015 "warm blob" on the West Coast, and the 2014-2016 heatwave and partially sea ice-free period in the Eastern Bering Sea. (The other such event in the Eastern Bering Sea was 2001-2005, which also appears to show up here.)

In addition to summing all CPUE (which will be driven by common species) I've calculated proportional change first at the single-species level and then averaged across all species in a region. This gives all species equal weight while also standardizing and centering catch values. This is shown below both as an absolute value (magnitude of change only) and from averaging across true units of single-species values. 

```{r namer-mhw-cpue-metrics, fig.cap="MHW Metrics vs. Sum CPUE Change", fig.height=7}
sppdat <- namerSppSummary %>% 
  group_by(region) %>% 
  filter(year > min(year)) %>% 
  group_by(region, year, ref_year) %>% 
  summarise(wtMtAnomPropMean = mean(wtMtAnomProp, na.rm=TRUE),
            wtMtAnomPropMeanAbs = mean(abs(wtMtAnomProp), na.rm=TRUE)) 

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data for plotting hot years
  left_join(sppdat) %>% 
  ggplot(aes(x=year)) + 
  geom_line(aes(y=anomIntC, color="Cumulative Mean MHW Intensity")) +
  geom_line(aes(y=anomDays/100, color="Number of SST Anomaly-Days Divided by 100")) +
  geom_line(aes(y=anomSev/100, color="MHW Severity (year sum) Divided by 100")) +
  geom_line(aes(y=wtMtDiffProp, color="Prop. Change CPUE vs. Last Year")) + 
  geom_line(aes(y=wtMtAnomProp, color="Prop. Change CPUE vs. Mean")) +
  geom_line(aes(y=wtMtAnomPropMean, color="Mean Single-Species CPUE Z-Score")) +
  geom_line(aes(y=wtMtAnomPropMeanAbs, color="Mean Absolute Single-Species CPUE Z-Score")) +
  geom_point(aes(y=sstCalYrAnom, color="Yearly MHW Index"), shape=8, size=2.5) +
  scale_color_manual(name = "", values = c("Cumulative Mean MHW Intensity" = "darkblue",
                                           "Number of SST Anomaly-Days Divided by 100" = "turquoise1",
                                           "MHW Severity (year sum) Divided by 100" = "royalblue1",
                                           "Yearly MHW Index" = "darkblue",
                                           "Prop. Change CPUE vs. Last Year" = "darkred",
                                           "Prop. Change CPUE vs. Mean" = "darkorange",
                                           
                                           "Mean Single-Species CPUE Z-Score" = "palevioletred2",
                                           "Mean Absolute Single-Species CPUE Z-Score" = "mediumvioletred")) +
  facet_wrap(~region, ncol=3) +
  labs(x="Year") + 
  theme_bw() +
  theme(
    legend.position="bottom"
  ) +
  guides(color=guide_legend(nrow=4,byrow=TRUE)) +
  NULL

# same plot just formatted slightly differently for writing out 
ggsummary <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data for plotting hot years
  left_join(sppdat) %>% 
  ggplot(aes(x=year)) + 
  geom_line(aes(y=anomIntC, color="Cumulative Mean MHW Intensity")) +
  geom_line(aes(y=anomDays/100, color="Number of SST Anomaly-Days Divided by 100")) +
  geom_line(aes(y=anomSev/100, color="MHW Severity (year sum) Divided by 100")) +
  geom_line(aes(y=wtMtDiffProp, color="Prop. Change CPUE vs. Last Year")) + 
  geom_line(aes(y=wtMtAnomProp, color="Prop. Change CPUE vs. Mean")) +
  geom_line(aes(y=wtMtAnomPropMean, color="Mean Single-Species CPUE Z-Score")) +
  geom_line(aes(y=wtMtAnomPropMeanAbs, color="Mean Absolute Single-Species CPUE Z-Score")) +
  geom_point(aes(y=sstCalYrAnom, color="Yearly MHW Index"), shape=8, size=2.5) +
  scale_color_manual(name = "", values = c("Cumulative Mean MHW Intensity" = "darkblue",
                                           "Number of SST Anomaly-Days Divided by 100" = "turquoise1",
                                           "MHW Severity (year sum) Divided by 100" = "royalblue1",
                                           "Yearly MHW Index" = "darkblue",
                                           "Prop. Change CPUE vs. Last Year" = "darkred",
                                           "Prop. Change CPUE vs. Mean" = "darkorange",
                                           
                                           "Mean Single-Species CPUE Z-Score" = "palevioletred2",
                                           "Mean Absolute Single-Species CPUE Z-Score" = "mediumvioletred")) +
  facet_wrap(~region, ncol=4) +
  labs(x="Year") + 
  theme_bw() +
  theme(
    legend.position="bottom"
  ) +
  guides(color=guide_legend(nrow=4,byrow=TRUE)) +
  NULL

ggsave(ggsummary, filename=here("results","line_plots_all_CPUE_MHW.png"), dpi=300, width=8, height=5)
```

```{r namer-mhw-years-cpue-scatter, fig.cap="Biomass Change vs MHW-Years", fig.height=7}

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=year, y=wtMtDiffProp, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x="Year",y="Prop. Change CPUE vs. Last Year")

ggscatter <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=year, y=wtMtDiffProp, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x="Year",y="Prop. Change CPUE vs. Last Year")

ggsave(ggscatter, filename=here("results","scatter_plots_all_CPUE_MHW.png"), dpi=300, width=8, height=5)

```


```{r namer-mhw-years-cpue-hist, fig.cap="Biomass Change vs MHW-Years", fig.height=7}

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data for plotting hot years
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=wtMtDiffProp, group=mhwYesNo, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_histogram() +
  theme_bw()

gghist <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidy) %>% # get calendar year data for plotting hot years 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=wtMtDiffProp, group=mhwYesNo, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_histogram() +
  theme_bw()

ggsave(gghist, filename=here("results","histograms_all_CPUE_MHW.png"), dpi=300, width=8, height=5)

```

### Species-level

```{r namer-spp-anom-mhw-scatter, fig.cap="Species Proportional CPUE Anomaly vs. MHW Intensity", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  ggplot() + 
  geom_point(aes(x=anomIntC, y=wtMtAnomProp, color=year, fill=year)) +
  theme_bw() + 
  labs(x="Cumulative Mean MHW Intensity",y="Prop. Change Species CPUE vs. Time-Series Mean")

```



```{r namer-spp-diff-mhw-scatter, fig.cap="Species Proportional CPUE Year-Over-Year Change vs. MHW Intensity", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  ggplot() + 
  geom_point(aes(x=anomIntC, y=wtMtDiffProp, color=year, fill=year)) +
  scale_y_continuous(trans="log10") +
  theme_bw() + 
  labs(x="Cumulative Mean MHW Intensity",y="Log10 Prop. Change Species CPUE vs. Last Year")

```



```{r namer-spp-diff-mhwYesNo-boxplot, fig.cap="Species Proportional CPUE Year-Over-Year Change in MHW and Non-MHW Years", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(mhwYesNo)) %>% 
  ggplot() + 
  geom_boxplot(aes(x=mhwYesNo, y=wtMtDiffProp)) +
  theme_bw() + 
  labs(x="MHW-Year?", y="Prop. Change Species CPUE vs. Last Year") +
  NULL

```

## Models

### MHW yes/no


```{r lm_wtMtDiffProp_mhwYesNo}
lm_wtMtDiffProp_mhwYesNo <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtDiffProp ~ mhwYesNo, data=.)

summary(lm_wtMtDiffProp_mhwYesNo)
```


```{r lm_wtMtAnomProp_mhwYesNo}
lm_wtMtAnomProp_mhwYesNo <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtAnomProp ~ mhwYesNo, data=.)

summary(lm_wtMtAnomProp_mhwYesNo)
```


```{r lm_wtMtAnomProp_mhwYesNo_region}
lm_wtMtAnomProp_mhwYesNo_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtAnomProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_wtMtAnomProp_mhwYesNo_region)
```

```{r lm_wtMtDiffProp_mhwYesNo_region}
lm_wtMtDiffProp_mhwYesNo_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtDiffProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_wtMtDiffProp_mhwYesNo_region)
```


```{r lm_spp_wtMtDiffProp_mhwYesNo_region}
lm_spp_wtMtDiffProp_mhwYesNo_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
    mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_spp_wtMtDiffProp_mhwYesNo_region)
```
```{r lm_spp_wtMtAnomProp_mhwYesNo_region}
lm_spp_wtMtAnomProp_mhwYesNo_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
    mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_spp_wtMtAnomProp_mhwYesNo_region)
```


### Net change in biomass 

```{r lm_wtMtDiffProp_anomIntC}
lm_wtMtDiffProp_anomIntC <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomIntC, data=.)

summary(lm_wtMtDiffProp_anomIntC)
```


```{r lm_wtMtAnomProp_anomIntC}
lm_wtMtAnomProp_anomIntC <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomIntC, data=.)

summary(lm_wtMtAnomProp_anomIntC)
```

```{r lm_wtMtDiffProp_anomIntC_region}
lm_wtMtDiffProp_anomIntC_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_wtMtDiffProp_anomIntC_region)
```


```{r lm_wtMtAnomProp_anomIntC_region}
lm_wtMtAnomProp_anomIntC_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_wtMtAnomProp_anomIntC_region)
```


```{r lm_wtMtAnomProp_anomDays_region}
lm_wtMtAnomProp_anomDays_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomDays + anomDays * region, data=.)

summary(lm_wtMtAnomProp_anomDays_region)
```


```{r lm_wtMtDiffProp_anomDays_region}
lm_wtMtDiffProp_anomDays_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomDays + anomDays * region, data=.)

summary(lm_wtMtDiffProp_anomDays_region)
```

```{r lm_wtMtAnomProp_anomSev_region}
lm_wtMtAnomProp_anomSev_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomSev + anomSev * region, data=.)

summary(lm_wtMtAnomProp_anomSev_region)
```


```{r lm_wtMtDiffProp_anomSev_region}
lm_wtMtDiffProp_anomSev_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomSev + anomSev * region, data=.)

summary(lm_wtMtDiffProp_anomSev_region)
```

### Species-level models


```{r lm_spp_wtMtDiffProp_anomIntC_region}
lm_spp_wtMtDiffProp_anomIntC_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_spp_wtMtDiffProp_anomIntC_region)
```


```{r lm_spp_wtMtDiffProp_anomDays_region}
lm_spp_wtMtDiffProp_anomDays_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomDays + anomDays * region, data=.)

summary(lm_spp_wtMtDiffProp_anomDays_region)
```

```{r lm_spp_wtMtDiffProp_anomSev_region}
lm_spp_wtMtDiffProp_anomSev_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomSev + anomSev * region, data=.)

summary(lm_spp_wtMtDiffProp_anomSev_region)
```


```{r lm_spp_wtMtDiffAnom_anomIntC_region}
lm_spp_wtMtAnomProp_anomIntC_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_spp_wtMtAnomProp_anomIntC_region)
```


```{r lm_spp_wtMtDiffAnom_anomDays_region}
lm_spp_wtMtAnomProp_anomDays_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomDays + anomDays * region, data=.)

summary(lm_spp_wtMtAnomProp_anomDays_region)
```

```{r lm_spp_wtMtDiffAnom_anomSev_region}
lm_spp_wtMtAnomProp_anomSev_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomSev + anomSev * region, data=.)

summary(lm_spp_wtMtAnomProp_anomSev_region)
```

