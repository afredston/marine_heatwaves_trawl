---
title: "Analyzing MHW effects on fish abundance in trawl surveys"
author: "Alexa Fredston"
date: "3/23/2021"
output: 
  github_document: default
---

# North America

Note that as of 05-20-2021, I've updated the analysis such that every survey is compared to MHW data from the 12 months preceding the earliest start month of the survey. Different seasons in a region are pooled, so e.g., the spring and fall NEUS surveys are compared to data from the 365 days before February 1 of each survey-year.

```{r include=FALSE}
knitr::opts_chunk$set(eval=TRUE, echo=FALSE, results=TRUE, message=FALSE, warning=FALSE) # set options for all chunks
```

```{r packages, results=FALSE}
library(tidyverse)
library(here)
library(lubridate) # for standardizing date format of MHW data
library(kableExtra)
```

```{r rawdata, results=FALSE}
mhwRaw <- read_delim(here("processed-data","MHW_95P_surveys_for_malin.csv"), ";") # file from Thomas - download and move to processed-data folder
mhwYrRaw <- read_delim(here("processed-data","mhws_90P_surveys_yearly.csv"), ";") 
namer_abund <- read_csv(here("processed-data","biomass_time_namer.csv"))
```

```{r datematch, results=FALSE}
# The goal of this part of code is to match each survey (noting that they start at different times of year in different regions, and don't all happen each year) to MHW data from only the 365 days preceding the survey in that region. It took me some time to hammer out this solution (and needed help from @GracoRoza and @KivaOken) and it could probably be rewritten to be shorter.

namerRegs <- c("aleutian_islands","eastern_bering_sea","gulf_of_alaska", "gulf_of_mexico","northeast","scotian_shelf","southeast","west_coast")

# step 1: get a dataframe of the survey start months
survey_start_times <- namer_abund%>%
  filter(year>=1982) %>% # start of MHW data
  mutate(region = gsub(" ","_",str_to_lower(region)), # reformat to be consistent with MHW region IDs
         region = gsub("_us","", region)) %>%
  mutate(month_year = paste0(startmonth,"-",year)) %>%
  select(region, year, month_year) %>%
  distinct() %>%
  mutate(ref_year = paste0(region,"-",month_year), # get unique survey identifier
         survey_date = dmy(paste0('01-',month_year)) # get earliest possible survey start date
  )

# get_survey_months <- function(reg){
#   out <- namer_abund %>% 
#   filter(year>=1982) %>% # start of MHW data
#   mutate(region = gsub(" ","_",str_to_lower(region)), # reformat to be consistent with MHW region IDs
#          region = gsub("_us","", region)) %>% 
#     filter(region==reg) %>% 
#     select(region, year, startmonth) %>% 
#     distinct() %>% 
#     mutate(month_year = paste0(startmonth,"-",year),
#            ref_year_start = paste0(startmonth+1,"-",year-1))
# }
# 
# floof <- map_dfr(namerRegs, get_survey_months )

# step 2: expand this out to all possible months, tracking which reference year they belong to
# get all month*year combinations for each survey and denote which reference year (12-month period custom to each region based on when survey began) each belongs to 
survey_years <- expand.grid(month=seq(1, 12, 1), year=seq(1982, 2018, 1), region=namerRegs) %>% # get a factorial combo of every possible month*year; have to start in 1982 even though we can't use surveys before 1983 because we need to match to env data from 1982
  mutate(region_month_year = paste0(region,"-",month,"-",year)) %>% # create unique identifier
  mutate(ref_year = ifelse(region_month_year %in% survey_start_times$ref_year, region_month_year, NA),
         month_year = paste0(month,"-",year)) %>% 
  select(region, month_year, ref_year) %>% 
  distinct() %>% 
  group_by(region) %>% 
  fill(ref_year, .direction="up") %>%  # fill in each region with the survey to which env data from each month*year should correspond
  ungroup() %>% 
  left_join(survey_start_times %>% select(ref_year, survey_date) %>% distinct(), by="ref_year") # add back in the survey start dates now that we've isolated the months of interest for temperature

# step 3: join this list of all months to the MHW data and then calculate statistics based on survey-years 
mhwSurv <- mhwRaw %>% 
  rename("dateRaw"=X1) %>% 
  pivot_longer(cols=2:ncol(mhwRaw), names_to="region", values_to="sstAnom") %>% # convert to "long" format
  mutate(sstAnom=replace_na(sstAnom, 0)) %>%  # DANGER -- overwriting the data Thomas sent to convert NAs ("no MHW") to zeros for easier arithmetic
  filter(region %in% namerRegs) %>% 
  mutate(date = dmy(dateRaw)) %>% # standardize date formats
  select(-dateRaw) %>% 
  mutate(year = year(date),
         month = month(date),
         month_year = paste0(month,"-",year)) %>% 
  left_join(survey_years, by=c('region','month_year')) %>% # note that because this is a left_join, and the mhw data starts at 1982, sometimes a ref_year is matched with many years of data preceding the survey -- this is corrected below when we keep only dates a certain lag value before the survey
  filter(!is.na(ref_year), # here, run mhwSurvYr %>% group_by(ref_year) %>% summarise(n=length(sstAnom)), and confirm that they are all at least 365 rows long. If not (i.e., if there were 1982 surveys we now need to filter out), filter out on next line
         !ref_year %in% c('northeast-2-1982','eastern_bering_sea-5-1982','scotian_shelf-6-1982')) %>% 
  mutate(date_lag = survey_date - date) %>% # how many days before the survey was the SST observation?
  filter(date_lag < 365,
         date_lag >= 0) # only keep SST data within 365 days of a survey for each region
```


```{r tidysurvey, results=FALSE}
#Make different summary datasets of survey data + MHW data

# stats pooled across all species 
namerSummary <- namer_abund %>% 
  filter(year>=1982) %>% # start of MHW data
  mutate(region = gsub(" ","_",str_to_lower(region)), # reformat to be consistent with MHW region IDs
         region = gsub("_us","", region)) %>% 
  left_join(survey_start_times, by=c('region','year')) %>% 
  group_by(ref_year, region, year) %>% 
  summarise(wt = sum(sumwt)) %>% # get total weight across all species for the region*year
  mutate(wtMt = wt/1000) %>% # convert to metric tons from kg
  group_by(region) %>% 
  arrange(year) %>% 
  mutate(wtMtDiff = wtMt - lag(wtMt), # calculate first difference (delta from last year surveyed--not always a one-year lag though!)
         wtMtDiffProp = (wtMtDiff / lag(wtMt)), # calculate proportional change
         wtMtAnom = wtMt - mean(wtMt), # subtract mean over all years within the region
         wtMtAnomProp = (wtMtAnom / mean(wtMt)) # get proportional difference of anomaly relative to mean
  ) 

# species-level stats
namerSppSummary <- namer_abund %>% 
  filter(year>=1982) %>% 
  mutate(region = gsub(" ","_",str_to_lower(region)),
         region = gsub("_us","", region)) %>% 
  mutate(wtMt = sumwt/1000) %>% 
  select(-sumwt) %>% 
  left_join(survey_start_times, by=c('region','year')) %>% 
  group_by(region, spp) %>% 
  arrange(year) %>% 
  mutate(wtMtDiff = wtMt - lag(wtMt), # calculate first difference (delta from last year; will be 3 years ago in WCTRI)
         wtMtDiffProp = (wtMtDiff / lag(wtMt)), # calculate proportional change
         wtMtDiffPropAbs = abs(wtMtDiffProp), 
         wtMtDiffPropAbsLog = log(wtMtDiffPropAbs),
         wtMtAnom = wtMt - mean(wtMt), # subtract mean over all years within the region
         wtMtAnomProp = (wtMtAnom / mean(wtMt)) # get proportional difference of anomaly relative to mean
  ) 

# get highest-biomass spp in each region 
topspp <- namerSppSummary %>% 
  group_by(region, spp) %>% 
  summarise(wtTotal = sum(wtMt)) %>% 
  group_by(region) %>% 
  arrange(-wtTotal) %>% 
  slice_head(n=5) %>%  # change this for different no. spp/reg
  mutate(sppReg = paste0(region, spp))
```

```{r tidymhw, results=FALSE}
# Make summary datasets with MHW data

# prep MHW for merging with surveys
mhwSurvSummary <- mhwSurv %>% 
  group_by(ref_year) %>% 
  summarise(
    anomDays = sum(sstAnom>0, na.rm=TRUE),# count number of non-NA anomaly days 
    anomSev = sum(sstAnom, na.rm=TRUE), # add up total anomaly values
    anomIntC = anomSev / anomDays # calculate cumulative mean intensity for every region*year 
  ) %>% 
  mutate(anomIntC = replace_na(anomIntC, 0)) # replacing NAs in AnomIntC that came from dividing by 0 with 0s

# datasets based on calendar year -- use only for characterizing regional MHWs, not for comparing to trawl data -- BE CAREFUL ABOUT MERGING THE DATASETS GENERATED BELOW THIS LINE WITH THE SURVEYS!
mhwTidy <- mhwRaw %>% 
  rename("dateRaw"=X1) %>% 
  pivot_longer(cols=2:ncol(mhwRaw), names_to="region", values_to="sstAnom") %>% # convert to "long" format
  mutate(date = dmy(dateRaw)) %>% # standardize date formats
  select(-dateRaw) %>% 
  mutate(year = year(date)) %>% 
  group_by(region, year) %>% 
  mutate(anomDays = sum(sstAnom>0, na.rm=TRUE),# count number of non-NA anomaly days 
         anomSev = sum(sstAnom, na.rm=TRUE), # add up total anomaly values
         anomIntC = anomSev / anomDays # calculate cumulative mean intensity for every region*year 
  )  %>% 
  ungroup()

mhwYrTidyPrep <- mhwYrRaw %>% 
  rename("year"=X1) %>% 
  pivot_longer(cols=2:ncol(mhwRaw), names_to="region", values_to="sstCalYrAnom") # convert to "long" format

mhwYrTidy <- mhwTidy %>% 
  select(region, year, anomDays, anomIntC, anomSev) %>% 
  distinct() %>% 
  mutate(anomIntC = replace_na(anomIntC, 0)) %>%  # replace NA values from calculating anomIntC with 0s
  left_join(mhwYrTidyPrep) # add in yearly MHW data 

```

## Plots

### Net changes in biomass

Let's plot several marine heatwave indices against several CPUE indices, to see how similar patterns are across metrics. I'm also looking for whether we see effects of major known MHW events: 2012 in the Northeast, the 2014-2015 "warm blob" on the West Coast, and the 2014-2016 heatwave and partially sea ice-free period in the Eastern Bering Sea. (The other such event in the Eastern Bering Sea was 2001-2005, which also appears to show up here.)

In addition to summing all CPUE (which will be driven by common species) I've calculated proportional change first at the single-species level and then averaged across all species in a region. This gives all species equal weight while also standardizing and centering catch values. This is shown below both as an absolute value (magnitude of change only) and from averaging across true units of single-species values. 

```{r namer-mhw-cpue-metrics, fig.cap="MHW Metrics vs. Sum CPUE Change", fig.height=7}
sppdat <- namerSppSummary %>% 
  group_by(region) %>% 
  filter(year > min(year)) %>% 
  group_by(region, year, ref_year) %>% 
  summarise(wtMtAnomPropMean = mean(wtMtAnomProp, na.rm=TRUE),
            wtMtAnomPropMeanAbs = mean(abs(wtMtAnomProp), na.rm=TRUE)) 

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data for plotting hot years
  left_join(sppdat) %>% 
  ggplot(aes(x=year)) + 
  geom_line(aes(y=anomIntC, color="Cumulative Mean MHW Intensity")) +
  geom_line(aes(y=anomDays/100, color="Number of SST Anomaly-Days Divided by 100")) +
  geom_line(aes(y=anomSev/100, color="MHW Severity (year sum) Divided by 100")) +
  geom_line(aes(y=wtMtDiffProp, color="Prop. Change CPUE vs. Last Year")) + 
  geom_line(aes(y=wtMtAnomProp, color="Prop. Change CPUE vs. Mean")) +
  geom_line(aes(y=wtMtAnomPropMean, color="Mean Single-Species CPUE Z-Score")) +
  geom_line(aes(y=wtMtAnomPropMeanAbs, color="Mean Absolute Single-Species CPUE Z-Score")) +
  geom_point(aes(y=sstCalYrAnom, color="Yearly MHW Index"), shape=8, size=2.5) +
  scale_color_manual(name = "", values = c("Cumulative Mean MHW Intensity" = "darkblue",
                                           "Number of SST Anomaly-Days Divided by 100" = "turquoise1",
                                           "MHW Severity (year sum) Divided by 100" = "royalblue1",
                                           "Yearly MHW Index" = "darkblue",
                                           "Prop. Change CPUE vs. Last Year" = "darkred",
                                           "Prop. Change CPUE vs. Mean" = "darkorange",
                                           
                                           "Mean Single-Species CPUE Z-Score" = "palevioletred2",
                                           "Mean Absolute Single-Species CPUE Z-Score" = "mediumvioletred")) +
  facet_wrap(~region, ncol=3) +
  labs(x="Year") + 
  theme_bw() +
  theme(
    legend.position="bottom"
  ) +
  guides(color=guide_legend(nrow=4,byrow=TRUE)) +
  NULL

# same plot just formatted slightly differently for writing out 
ggsummary <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data for plotting hot years
  left_join(sppdat) %>% 
  ggplot(aes(x=year)) + 
  geom_line(aes(y=anomIntC, color="Cumulative Mean MHW Intensity")) +
  geom_line(aes(y=anomDays/100, color="Number of SST Anomaly-Days Divided by 100")) +
  geom_line(aes(y=anomSev/100, color="MHW Severity (year sum) Divided by 100")) +
  geom_line(aes(y=wtMtDiffProp, color="Prop. Change CPUE vs. Last Year")) + 
  geom_line(aes(y=wtMtAnomProp, color="Prop. Change CPUE vs. Mean")) +
  geom_line(aes(y=wtMtAnomPropMean, color="Mean Single-Species CPUE Z-Score")) +
  geom_line(aes(y=wtMtAnomPropMeanAbs, color="Mean Absolute Single-Species CPUE Z-Score")) +
  geom_point(aes(y=sstCalYrAnom, color="Yearly MHW Index"), shape=8, size=2.5) +
  scale_color_manual(name = "", values = c("Cumulative Mean MHW Intensity" = "darkblue",
                                           "Number of SST Anomaly-Days Divided by 100" = "turquoise1",
                                           "MHW Severity (year sum) Divided by 100" = "royalblue1",
                                           "Yearly MHW Index" = "darkblue",
                                           "Prop. Change CPUE vs. Last Year" = "darkred",
                                           "Prop. Change CPUE vs. Mean" = "darkorange",
                                           
                                           "Mean Single-Species CPUE Z-Score" = "palevioletred2",
                                           "Mean Absolute Single-Species CPUE Z-Score" = "mediumvioletred")) +
  facet_wrap(~region, ncol=4) +
  labs(x="Year") + 
  theme_bw() +
  theme(
    legend.position="bottom"
  ) +
  guides(color=guide_legend(nrow=4,byrow=TRUE)) +
  NULL

ggsave(ggsummary, filename=here("results","line_plots_all_CPUE_MHW.png"), dpi=300, width=8, height=5)
```

```{r namer-mhw-years-cpue-scatter, fig.cap="Biomass Change vs MHW-Years", fig.height=7}

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=year, y=wtMtDiffProp, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x="Year",y="Prop. Change CPUE vs. Last Year")

ggscatter <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=year, y=wtMtDiffProp, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_point(size=3) +
  theme_bw() + 
  labs(x="Year",y="Prop. Change CPUE vs. Last Year")

ggsave(ggscatter, filename=here("results","scatter_plots_all_CPUE_MHW.png"), dpi=300, width=8, height=5)

```


```{r namer-mhw-years-cpue-hist, fig.cap="Biomass Change vs MHW-Years", fig.height=7}

namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data for plotting hot years
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=wtMtDiffProp, group=mhwYesNo, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_histogram() +
  theme_bw()

gghist <- namerSummary %>% 
  left_join (mhwSurvSummary, by="ref_year") %>% # get MHW data matched to surveys
  filter(year>=1982, !is.na(wtMtDiffProp)) %>% 
  left_join(mhwYrTidyPrep) %>% # get calendar year data for plotting hot years 
  mutate(mhwYesNo = ifelse(is.na(sstCalYrAnom), "No","Yes")) %>% 
  ggplot(aes(x=wtMtDiffProp, group=mhwYesNo, color=mhwYesNo, fill=mhwYesNo)) +
  scale_color_manual(values=c("black","red")) + 
  scale_fill_manual(values=c("black","red")) + 
  geom_histogram() +
  theme_bw()

ggsave(gghist, filename=here("results","histograms_all_CPUE_MHW.png"), dpi=300, width=8, height=5)

```

### Species-level

```{r namer-spp-anom-mhw-scatter, fig.cap="Species Proportional CPUE Anomaly vs. MHW Intensity", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  ggplot() + 
  geom_point(aes(x=anomIntC, y=wtMtAnomProp, color=year, fill=year)) +
  theme_bw() + 
  labs(x="Cumulative Mean MHW Intensity",y="Prop. Change Species CPUE vs. Time-Series Mean")

```



```{r namer-spp-diff-mhw-scatter, fig.cap="Species Proportional CPUE Year-Over-Year Change vs. MHW Intensity", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  ggplot() + 
  geom_point(aes(x=anomIntC, y=wtMtDiffProp, color=year, fill=year)) +
  scale_y_continuous(trans="log10") +
  theme_bw() + 
  labs(x="Cumulative Mean MHW Intensity",y="Log10 Prop. Change Species CPUE vs. Last Year")

```



```{r namer-spp-diff-mhwYesNo-boxplot, fig.cap="Species Proportional CPUE Year-Over-Year Change in MHW and Non-MHW Years", fig.height=5}
left_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(mhwYesNo)) %>% 
  ggplot() + 
  geom_boxplot(aes(x=mhwYesNo, y=wtMtDiffProp)) +
  theme_bw() + 
  labs(x="MHW-Year?", y="Prop. Change Species CPUE vs. Last Year") +
  NULL

```

## Models

### MHW yes/no


```{r lm_wtMtDiffProp_mhwYesNo}
lm_wtMtDiffProp_mhwYesNo <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtDiffProp ~ mhwYesNo, data=.)

summary(lm_wtMtDiffProp_mhwYesNo)
```


```{r lm_wtMtAnomProp_mhwYesNo}
lm_wtMtAnomProp_mhwYesNo <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtAnomProp ~ mhwYesNo, data=.)

summary(lm_wtMtAnomProp_mhwYesNo)
```


```{r lm_wtMtAnomProp_mhwYesNo_region}
lm_wtMtAnomProp_mhwYesNo_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtAnomProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_wtMtAnomProp_mhwYesNo_region)
```

```{r lm_wtMtDiffProp_mhwYesNo_region}
lm_wtMtDiffProp_mhwYesNo_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  lm(wtMtDiffProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_wtMtDiffProp_mhwYesNo_region)
```


```{r lm_spp_wtMtDiffProp_mhwYesNo_region}
lm_spp_wtMtDiffProp_mhwYesNo_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
    mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_spp_wtMtDiffProp_mhwYesNo_region)
```
```{r lm_spp_wtMtAnomProp_mhwYesNo_region}
lm_spp_wtMtAnomProp_mhwYesNo_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
    mutate(mhwYesNo = ifelse(anomDays > 0, "yes", "no")) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ mhwYesNo + mhwYesNo * region, data=.)

summary(lm_spp_wtMtAnomProp_mhwYesNo_region)
```


### Net change in biomass 

```{r lm_wtMtDiffProp_anomIntC}
lm_wtMtDiffProp_anomIntC <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomIntC, data=.)

summary(lm_wtMtDiffProp_anomIntC)
```


```{r lm_wtMtAnomProp_anomIntC}
lm_wtMtAnomProp_anomIntC <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomIntC, data=.)

summary(lm_wtMtAnomProp_anomIntC)
```

```{r lm_wtMtDiffProp_anomIntC_region}
lm_wtMtDiffProp_anomIntC_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_wtMtDiffProp_anomIntC_region)
```


```{r lm_wtMtAnomProp_anomIntC_region}
lm_wtMtAnomProp_anomIntC_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_wtMtAnomProp_anomIntC_region)
```


```{r lm_wtMtAnomProp_anomDays_region}
lm_wtMtAnomProp_anomDays_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomDays + anomDays * region, data=.)

summary(lm_wtMtAnomProp_anomDays_region)
```


```{r lm_wtMtDiffProp_anomDays_region}
lm_wtMtDiffProp_anomDays_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomDays + anomDays * region, data=.)

summary(lm_wtMtDiffProp_anomDays_region)
```

```{r lm_wtMtAnomProp_anomSev_region}
lm_wtMtAnomProp_anomSev_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtAnomProp ~ anomSev + anomSev * region, data=.)

summary(lm_wtMtAnomProp_anomSev_region)
```


```{r lm_wtMtDiffProp_anomSev_region}
lm_wtMtDiffProp_anomSev_region <- inner_join(namerSummary, mhwSurvSummary) %>% 
  lm(wtMtDiffProp ~ anomSev + anomSev * region, data=.)

summary(lm_wtMtDiffProp_anomSev_region)
```

### Species-level models


```{r lm_spp_wtMtDiffProp_anomIntC_region}
lm_spp_wtMtDiffProp_anomIntC_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_spp_wtMtDiffProp_anomIntC_region)
```


```{r lm_spp_wtMtDiffProp_anomDays_region}
lm_spp_wtMtDiffProp_anomDays_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomDays + anomDays * region, data=.)

summary(lm_spp_wtMtDiffProp_anomDays_region)
```

```{r lm_spp_wtMtDiffProp_anomSev_region}
lm_spp_wtMtDiffProp_anomSev_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtDiffProp),
         wtMtDiffProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtDiffProp ~ anomSev + anomSev * region, data=.)

summary(lm_spp_wtMtDiffProp_anomSev_region)
```


```{r lm_spp_wtMtDiffAnom_anomIntC_region}
lm_spp_wtMtAnomProp_anomIntC_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomIntC + anomIntC * region, data=.)

summary(lm_spp_wtMtAnomProp_anomIntC_region)
```


```{r lm_spp_wtMtDiffAnom_anomDays_region}
lm_spp_wtMtAnomProp_anomDays_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomDays + anomDays * region, data=.)

summary(lm_spp_wtMtAnomProp_anomDays_region)
```

```{r lm_spp_wtMtDiffAnom_anomSev_region}
lm_spp_wtMtAnomProp_anomSev_region <- inner_join(namerSppSummary, mhwSurvSummary) %>% 
  filter(!is.na(wtMtAnomProp),
         wtMtAnomProp < Inf) %>% # because the proportion becomes Inf if previous year was 0
  lm(wtMtAnomProp ~ anomSev + anomSev * region, data=.)

summary(lm_spp_wtMtAnomProp_anomSev_region)
```

